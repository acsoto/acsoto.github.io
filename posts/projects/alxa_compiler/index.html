<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Alxa_Compiler(SysY to PCODE) | SOTO-BLOG</title>
<meta name="keywords" content="BUAA, 项目">
<meta name="description" content="Lexical analysis Before Code Requriement: read testfile.txt, parse every char to word and print them. At the same time, memorize type, content and line number of each word.
File reading Read by line, scan every char of every string and analyse.
while ((s = bf.readLine()) != null) { ... } Analyse When i get the key word, enter the next analyst.
while ((c = getChar()) != null) { if (c == &#39; &#39; || c == &#39;\r&#39; || c == &#39;\t&#39;) { continue; } else if (c == &#39;&#43;&#39; || c == &#39;-&#39; || c == &#39;*&#39; || c == &#39;%&#39;) { words.">
<meta name="author" content="SOTO">
<link rel="canonical" href="https://zzhgo.com/posts/projects/alxa_compiler/">
<meta name="google-site-verification" content="XYZabc">
<meta name="yandex-verification" content="XYZabc">
<meta name="msvalidate.01" content="XYZabc">
<link crossorigin="anonymous" href="/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css" integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://zzhgo.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://zzhgo.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://zzhgo.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://zzhgo.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://zzhgo.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Alxa_Compiler(SysY to PCODE)" />
<meta property="og:description" content="Lexical analysis Before Code Requriement: read testfile.txt, parse every char to word and print them. At the same time, memorize type, content and line number of each word.
File reading Read by line, scan every char of every string and analyse.
while ((s = bf.readLine()) != null) { ... } Analyse When i get the key word, enter the next analyst.
while ((c = getChar()) != null) { if (c == &#39; &#39; || c == &#39;\r&#39; || c == &#39;\t&#39;) { continue; } else if (c == &#39;&#43;&#39; || c == &#39;-&#39; || c == &#39;*&#39; || c == &#39;%&#39;) { words." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zzhgo.com/posts/projects/alxa_compiler/" />
<meta property="og:image" content="https://pic.mcac.cc/202212310105664.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-16T16:29:00+00:00" />
<meta property="article:modified_time" content="2021-11-16T16:29:00+00:00" /><meta property="og:site_name" content="SOTO-BLOG" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://pic.mcac.cc/202212310105664.png" />
<meta name="twitter:title" content="Alxa_Compiler(SysY to PCODE)"/>
<meta name="twitter:description" content="Lexical analysis Before Code Requriement: read testfile.txt, parse every char to word and print them. At the same time, memorize type, content and line number of each word.
File reading Read by line, scan every char of every string and analyse.
while ((s = bf.readLine()) != null) { ... } Analyse When i get the key word, enter the next analyst.
while ((c = getChar()) != null) { if (c == &#39; &#39; || c == &#39;\r&#39; || c == &#39;\t&#39;) { continue; } else if (c == &#39;&#43;&#39; || c == &#39;-&#39; || c == &#39;*&#39; || c == &#39;%&#39;) { words."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://zzhgo.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Alxa_Compiler(SysY to PCODE)",
      "item": "https://zzhgo.com/posts/projects/alxa_compiler/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Alxa_Compiler(SysY to PCODE)",
  "name": "Alxa_Compiler(SysY to PCODE)",
  "description": "Lexical analysis Before Code Requriement: read testfile.txt, parse every char to word and print them. At the same time, memorize type, content and line number of each word.\nFile reading Read by line, scan every char of every string and analyse.\nwhile ((s = bf.readLine()) != null) { ... } Analyse When i get the key word, enter the next analyst.\nwhile ((c = getChar()) != null) { if (c == \u0026#39; \u0026#39; || c == \u0026#39;\\r\u0026#39; || c == \u0026#39;\\t\u0026#39;) { continue; } else if (c == \u0026#39;+\u0026#39; || c == \u0026#39;-\u0026#39; || c == \u0026#39;*\u0026#39; || c == \u0026#39;%\u0026#39;) { words.",
  "keywords": [
    "BUAA", "项目"
  ],
  "articleBody": "Lexical analysis Before Code Requriement: read testfile.txt, parse every char to word and print them. At the same time, memorize type, content and line number of each word.\nFile reading Read by line, scan every char of every string and analyse.\nwhile ((s = bf.readLine()) != null) { ... } Analyse When i get the key word, enter the next analyst.\nwhile ((c = getChar()) != null) { if (c == ' ' || c == '\\r' || c == '\\t') { continue; } else if (c == '+' || c == '-' || c == '*' || c == '%') { words.add(new Word(c)); } else if (c == '/') { analyseSlash(); } else if (c == '(' || c == ')' || c == '[' || c == ']' || c == '{' || c == '}') { words.add(new Word(c)); } else if (c == '\u003e' || c == '\u003c' || c == '=' || c == '!') { analyseRelation(c); } else if (c == ',' || c == ';') { words.add(new Word(c)); } else if (c == '\"') { analyseCitation(); } else if (c == '\u0026' || c == '|') { analyseLogic(c); } else if (Character.isDigit(c)) { analyseDigit(c); } else if (Character.isLetter(c) || c == '_') { analyseLetter(c); } } Common For example, when I get ‘+’, I directly new a Word typify the “PLUS”.\nFunction For example\nWhen I get \u003c , enter functionanalyseRelation read one char more. If it is=, analyze LEQ…\nif (c == '\u003c') { c = getChar(); if (c == '=') { words.add(new Word(\"\u003c=\")); } else { unGetChar(); words.add(new Word(\"\u003c\")); } analyseLogic is as the same.\nDigit and Letter Digit: When I get a digit, it means I will scan a serial of some digits and turn them into a Word typify “INTCON”.\nLetter: When I get a letter, it means I will scan a string about letter or digit. It maybe a “IDENFR” or “STRCON”, which depends on whether it is in key map or not.\nWord class Word:\npublic class Word { private String identification; private String content; private String type; } Capsulate the initial function, I only need to new Word(...) in the main processor, which will create the corresponding word.\nFor example\npublic Word(char identification) { this.identification = String.valueOf(identification); this.type = new KeyWordMap().getType(this.identification); this.content = this.identification; } As for KeyWordMap, it is a HashMap, mapping the string of word and its type.\npublic KeyWordMap() { keyWords = new HashMap\u003c\u003e(); keyWords.put(\"main\", \"MAINTK\"); keyWords.put(\"const\", \"CONSTTK\"); keyWords.put(\"int\", \"INTTK\"); ... } After Code File reading Read file by line is not convenient for preread and undo, so I read the file into a single String at first.\nThe method is read by line, add \\n after every line and scan every char. When I get \\n, lineNum++\nprivate String transferFileToCode() { BufferedReader bf = new BufferedReader(reader); StringBuffer buffer = new StringBuffer(); String s = null; while ((s = bf.readLine()) != null) { buffer.append(s).append(\"\\n\"); } return buffer.toString(); } Analyse About analyst, it is different from what before coding.\nFirst, I need analyze word one by one, so I add global variety index to memorize where is the pointer.\nBesides, I met the situation that I need read one more or undo, so I encapsulate the function ungetChar and getChar, which will be convenient for me to analyze.\nprivate Character getChar() { if (index \u003c code.length()) { char c = code.charAt(index); if (c == '\\n') { lineNum++; } index++; return c; } else { return null; } } private void unGetChar() { index--; char c = code.charAt(index); if (c == '\\n') { lineNum--; } } Slash // : When it comes to \\n , stop. do { c = getChar(); if (c == null || c == '\\n') { return; // 判断为//注释，结束分析 } } while (true); /* */: Get char until */ appears do { c = getChar(); if (c == null) { return; } if (c == '*') { c = getChar(); if (c == '/') { return; // 判断为/* */注释，直接结束分析 } else { unGetChar(); } } } while (true); Grammatical analysis Requirement: Based on the words identified by the lexical analysis program, identify various grammatical elements according to the grammatical rules. Recursive descent method is used to analyze the grammatical components defined in the grammar.\nBefore Code Data Reading Like the lexical analyst, I prepared function getWord getNextWord and so on. At the same time, there is a global variety (Word) curWord to display which word it is when I read ArrayList words from lexical analyst one by one.\nMy analyst tragedy is as follows:\nTo normal rule: I keep getting words and analyze them\nTo expression rule: I scan the whole expression first, which is implemented by function getExp. Then I divide the expression and use method recursive descent to analyze them.\ngetExp like\nprivate ArrayList\u003cWord\u003e getExp() { ArrayList\u003cWord\u003e exp = new ArrayList\u003c\u003e(); while (true) { if (word is symbol of end) { break; } ... getWordWithoutAddToGrammar(); exp.add(curWord); word = getNextWord(); } return exp; } recursive descent According to Grammatical Rules, code function for every term of rule.\nMain idea: read a word, check what it symbolize and enter the next analyzing function.\nFor example:\nto\nCompUnit → {Decl} {FuncDef} MainFuncDef // 1.是否存在Decl 2.是否存在 FuncDef I analyze like this:\nprivate void analyseCompUnit() { Word word = getNextWord(); while (word.typeEquals(\"CONSTTK\") || ( word.typeEquals(\"INTTK\") \u0026\u0026 getNext2Word().typeEquals(\"IDENFR\") \u0026\u0026 !getNext3Word().typeEquals(\"LPARENT\"))) { analyseDecl(); word = getNextWord(); } while (word.typeEquals(\"VOIDTK\") || ( (word.typeEquals(\"INTTK\") \u0026\u0026 !getNext2Word().typeEquals(\"MAINTK\")))) { analyseFuncDef(); word = getNextWord(); } if (word.typeEquals(\"INTTK\") \u0026\u0026 getNext2Word().typeEquals(\"MAINTK\")) { analyseMainFuncDef(); } else { error(); } grammar.add(\"\"); } grammar is used for memorize output of lexical analyst and grammar analyst list.\nleft recursion 加减表达式 AddExp → MulExp | AddExp ('+' | '−') MulExp // 1.MulExp 2.+ 需覆盖 3.- 需覆盖 Check if the exp has ‘+’ or ‘-’. If it has, separate the exp to AddExp and MulExp. Then analyze them separately.\nAfter Code left recursion The method used before is not perfect for recursive descent. So I changed my rewrite way.\nto\n加减表达式 AddExp → MulExp | AddExp ('+' | '−') MulExp // 1.MulExp 2.+ 需覆盖 3.- 需覆盖 Rewrite it like\nAddExp → MulExp ('+' | '−') MulExp ('+' | '−') MulExp ... Code like\nprivate void analyseMulExp(ArrayList\u003cWord\u003e exp) { Exps exps = divideExp(exp, new ArrayList\u003c\u003e(Arrays.asList(\"MULT\", \"DIV\", \"MOD\"))); int j = 0; for (ArrayList\u003cWord\u003e exp1 : exps.getWords()) { analyseUnaryExp(exp1); grammar.add(\"\"); if (j \u003c exps.getSymbols().size()) { grammar.add(exps.getSymbols().get(j++).toString()); } } } Function divideExp is used for divide the whole exp passed by getExp or the pre function.\ndivideExp:\nIn: orignal: exp stop symbol: symbol\nOut: List of divided exp and symbol.\nprivate Exps divideExp(ArrayList\u003cWord\u003e exp, ArrayList\u003cString\u003e symbol) { ArrayList\u003cArrayList\u003cWord\u003e\u003e exps = new ArrayList\u003c\u003e(); ArrayList\u003cWord\u003e exp1 = new ArrayList\u003c\u003e(); ArrayList\u003cWord\u003e symbols = new ArrayList\u003c\u003e(); boolean unaryFlag = false; int flag1 = 0; int flag2 = 0; for (int i = 0; i \u003c exp.size(); i++) { Word word = exp.get(i); if (word.typeEquals(\"LPARENT\")) { flag1++; } if (word.typeEquals(\"RPARENT\")) { flag1--; } if (word.typeEquals(\"LBRACK\")) { flag2++; } if (word.typeEquals(\"RBRACK\")) { flag2--; } if (symbol.contains(word.getType()) \u0026\u0026 flag1 == 0 \u0026\u0026 flag2 == 0) { //UnaryOp if (word.typeOfUnary()) { if (!unaryFlag) { exp1.add(word); continue; } } exps.add(exp1); symbols.add(word); exp1 = new ArrayList\u003c\u003e(); } else { exp1.add(word); } unaryFlag = word.typeEquals(\"IDENFR\") || word.typeEquals(\"RPARENT\") || word.typeEquals(\"INTCON\") || word.typeEquals(\"RBRACK\"); } exps.add(exp1); return new Exps(exps, symbols); } Exps\npublic class Exps { private ArrayList\u003cArrayList\u003cWord\u003e\u003e words; private ArrayList\u003cWord\u003e symbols; } other bugs Most bugs are produced by function getExp and divideExp because of some situations are ignored. So I always get something like index out of range…\nSo I changed some symbol of stop getting expression and modify the rules to divide or not the expression and so on.\nError handling Official errors defination\nBefore Code Create the symbol table Symbol class\npublic class Symbol { private String type; private int intType; private String content; private int area = 0; } Type means the type of the symbol.\nIntType is an integer. If it’s 0, the symbol is int. if it’s 1, the symbol is int[], if it’s 2, the symbol is int[] []…\nContent is its content.\nArea is where is it.\nI create a HashMap of Symbols, memorizing symbols created in each area.\nWhen I enter a new area, area++. When I leave an area, area–, with the corresponding Symbols are destroyed.\nprivate HashMap\u003cInteger, Symbols\u003e symbols = new HashMap\u003c\u003e(); private HashMap\u003cString, Function\u003e functions = new HashMap\u003c\u003e(); private ArrayList\u003cError\u003e errors = new ArrayList\u003c\u003e(); private int area = -1; private boolean needReturn = false; private int whileFlag = 0; needReturn means if the current function need to return.\nwhileFlag means if the current code block is in while circle.\nErrors a Just check format\npublic boolean isFormatIllegal() { for (int i = 1; i \u003c content.length() - 1; i++) { char c = content.charAt(i); if (!isLegal(c)) { if (c == '%' \u0026\u0026 content.charAt(i + 1) == 'd') { continue; } return true; } else { if (c == '\\\\' \u0026\u0026 content.charAt(i + 1) != 'n') { return true; } } } return false; } private boolean isLegal(char c) { return c == 32 || c == 33 || (c \u003e= 40 \u0026\u0026 c \u003c= 126); //offical defination } b c B: Every time I get an identity, check if there is the same symbol has been defined in this area.\nprivate boolean hasSymbolInThisArea(Word word) { return symbols.get(area).hasSymbol(word); } C: Check all area. If the symbol has been defined. Functions are as the same.\nprivate boolean hasSymbol(Word word) { for (Symbols s : symbols.values()) { if (s.hasSymbol(word)) { return true; } } return false; } d e To check if the function parameters are matched, I memorize parameters of every function and when I met a function call, I will scan the function call parameters and match them. I prepare a function to do this. Finally I found I need to use recursive descent again, so I add the check procedure to the recursive descent of the grammatical analyst. Please check the After Code/Error d and e\nf g There is a global variety needReturn used to display if the current function need return. if it does but there is no return in the end of the code block, or if it doesn’t but there is return, the error will be memorized.\nh Just check if it is a const.\nif (isConst(word)) { error(\"h\", word.getLineNum()); } i j k Capsulate function about checking missing of the symbol\nFor example:\nprivate void checkParent() { if (getNextWord().typeEquals(\"RPARENT\")) { getWord();// ) } else { error(\"j\"); } } l Count the number of the parameters of string and printf separately and check if they equal.\nm There is a global variety whileFlag symbolize if the code block is in while circle. If it isn’t, any continue and break will produce error.\nAfter Code Area I mark the area++ when I get a block or a function, but it will lead to the situation that when enter a code block of a function, the parameters of the function can’t be memorize in the different are with the block of the function. So I changed the rules to mark area++.\nprivate boolean analyseBlock(boolean fromFunc) { ... if (!fromFunc) { addArea(); } ... } Only when the block is not from the function, the area++.\nError d and e To check if the function parameters are matched, I set an array for every function.\npublic class Function { private String type; private String content; private String returnType; private ArrayList\u003cInteger\u003e paras; } When I get a function, I memorize its return type and paras.\nAs for the ArrayList paras, it reflects as follows:\nType Example Integer Void -1 Int a 0 Int[] a[] 1 Int[] [] a[] [3] 2 So when I get a function call, I will check the parameter of it with what I have memorized before.\nprivate void checkParasMatchRParas(Word ident, ArrayList\u003cInteger\u003e paras, ArrayList\u003cInteger\u003e rparas) { if (paras.size() != rparas.size()) { error(\"d\", ident.getLineNum()); } else { for (int i = 0; i \u003c paras.size(); i++) { if (!paras.get(i).equals(rparas.get(i))) { error(\"e\", ident.getLineNum()); } } } } As for getting the parameters real type, I add the analyst procedure to the recursive descent of the grammatical analyst. Just like:\nprivate int analyseExp(ArrayList\u003cWord\u003e exp) { int intType = analyseAddExp(exp); grammar.add(\"\"); return intType; } Every recursion will return an intType, which symbolize the final type of the expression.\nBecause the terms of one expression must be the same type, so I return only one of them.\nThis is the exit of the recursion. It will return a correct type of the expression to the top of the function.\nprivate int analyseLVal(ArrayList\u003cWord\u003e exp) { int intType = 0; ... if (word.typeEquals(\"LBRACK\")) { intType++; ... } ... if (hasSymbol(ident)) { return getSymbol(ident).getIntType() - intType; } else { return 0; } } Code generation In this part, I chose to generate Pcode.\nI designed a type of Pcode which is an Inverse Bolan expression stack and symbol table based virtual code.\nAt the same time, I designed virtual machine to execute them.\nThe Pcode virtual machine is an imaginary machine used to run Pcode commands. It consists of: A code area (code), an instruction pointer (EIP), a stack, a var_table, a func_table and a label_table.\nIn the following passage, I will introduce how Pcode executes first and how to produce Pcode next.\nBefore Code How does the virtual machine run First, we need a codes list and a stack(int).\nAn eip: presents the address of current running code.\nA varTable: memorizes the address of the variety in stack.\nA funcTable: memorizes the address of the function in codes list.\nA labelTable: Memorizes the address of the label in codes list.\nThen, run the code one after another and manage the stack.\nHow to distinguish different variety Before generate codes, differentiate varieties from different scopes by its only scope number, like: areaID + \"_\" + curWord.getContent(). In this situation, the variety will not appear more than once in codes, except for recursive function call, which will be solved by push varTable to stack(show later).\nSpecific Code Definition First, define a class for PCode:\npublic class PCode { private CodeType type; private Object value1 = null; private Object value2 = null; } It presents one code object, which has a CodeType and two operating values. CodeType is an enum. Value1 and value2 maybe Integer or String or null, which depends on specific code type.\nCalculation Type Two operators:\nint b = pop(); int a = pop(); push(cal(a,b)); Single operator:\npush(cal(pop())); VAR VAR command to declare a variable, save the variable name and the address assigned to it in the variable table.\ncase VAR: { Var var = new Var(stack.size()); varTable.put((String) code.getValue1(), var); } Var.class:\npublic class Var { private int index; private int dimension = 0; private int dim1; private int dim2; } DIMVAR DIMVAR command to declare an array. Set the dimension information of the var.\ncase DIMVAR: { Var var = getVar((String) code.getValue1()); int n = (int) code.getValue2(); var.setDimension(n); if (n == 1) { int i = pop(); var.setDim1(i); } if (n == 2) { int j = pop(), i = pop(); var.setDim1(i); var.setDim2(j); } } PLACEHOLDER PLACEHOLDER command to grow the stack down, allocate the new space to the variety and array.\ncase PLACEHOLDER: { Var var = getVar((String) code.getValue1()); int n = (int) code.getValue2(); if (n == 0) { push(0); } if (n == 1) { for (int i = 0; i \u003c var.getDim1(); i++) { push(0); } } if (n == 2) { for (int i = 0; i \u003c var.getDim1() * var.getDim2(); i++) { push(0); } } } Other Calculation type: pop the stack top once or twice, calculate them and push again.\nJump Type: When it’s command about jump, just check if the condition is satisfied and change the eip.\nFunction call: as follows\nFunction call procedure First, before function call, there will be some parameters to be pushed into the stack. Each will be followed by a RPARA command, which memorize the address of the previous variety.\ncase RPARA: { int n = (int) code.getValue1(); if (n == 0) { rparas.add(stack.size() - 1); } else { rparas.add(stack.get(stack.size() - 1)); } } Second, function CALL.\nMemorize the eip, stack top address, and information about the function(In fact, they will be pushed into stack too). Then update the varTable and eip. Ready for execute function.\ncase CALL: { Func func = funcTable.get((String) code.getValue1()); retInfos.add(new RetInfo(eip, varTable, stack.size() - 1, func.getArgs(), func.getArgs(), nowArgsNum)); eip = func.getIndex(); varTable = new HashMap\u003c\u003e(); callArgsNum = func.getArgs(); nowArgsNum = 0; } Finally, return when it’s RET\nRestore eip, varTable from RetInfo, clear the new information pushed when function in the stack.\ncase RET: { int n = (int) code.getValue1(); RetInfo info = retInfos.remove(retInfos.size() - 1); eip = info.getEip(); varTable = info.getVarTable(); callArgsNum = info.getCallArgsNum(); nowArgsNum = info.getNowArgsNum(); if (n == 1) { stack.subList(info.getStackPtr() + 1 - info.getParaNum(), stack.size() - 1).clear(); } else { stack.subList(info.getStackPtr() + 1 - info.getParaNum(), stack.size()).clear(); } } Value or Address Push value or address of the variety is an important thing, it depends on what I need, which will be presented when I describe how to generate codes.\nThe command action is as follows(getAddress is used for get the address of the previous variety ).\ncase VALUE: { Var var = getVar((String) code.getValue1()); int n = (int) code.getValue2(); int address = getAddress(var, n); push(stack.get(address)); } ... case ADDRESS: { Var var = getVar((String) code.getValue1()); int n = (int) code.getValue2(); int address = getAddress(var, n); push(address); } Code Generate Code generated from the grammatical analyst procedure.\nDeclaration There is no need to distinguish const and var. When declare a variety, just new a variety and let it point to the stack top. Then if it has an initialization, just push the values one after another. If not, add a PLACEHOLDER command to push something(I push 0) to the stack to hold the place.\nAssign sentence In this situation, first calculate and push the address of the variety to the stack top. Then analyze expressions. After that, there are only two number in the stack, which are address and value. Assign the value to the address.\nCondition control sentence First, generate labels. Then, place jump sentences in the proper places.\nlabels about if and while will be generated and then stored in a stack type structure. like:\nwhileLabels.add(new HashMap\u003c\u003e()); whileLabels.get(whileLabels.size() - 1).put(\"while\", labelGenerator.getLabel(\"while\")); whileLabels.get(whileLabels.size() - 1).put(\"while_end\", labelGenerator.getLabel(\"while_end\")); whileLabels.get(whileLabels.size() - 1).put(\"while_block\", labelGenerator.getLabel(\"while_block\")); Take if as example:\nif (word.typeEquals(\"IFTK\")) { codes.add(new PCode(CodeType.LABEL, ifLabels.get(ifLabels.size() - 1).get(\"if\"))); ... analyseCond(\"IFTK\"); ... codes.add(new PCode(CodeType.JZ, ifLabels.get(ifLabels.size() - 1).get(\"else\"))); codes.add(new PCode(CodeType.LABEL, ifLabels.get(ifLabels.size() - 1).get(\"if_block\"))); analyseStmt(); codes.add(new PCode(CodeType.JMP, ifLabels.get(ifLabels.size() - 1).get(\"if_end\"))); codes.add(new PCode(CodeType.LABEL, ifLabels.get(ifLabels.size() - 1).get(\"else\"))); if (word.typeEquals(\"ELSETK\")) { getWord(); //else analyseStmt(); } codes.add(new PCode(CodeType.LABEL, ifLabels.get(ifLabels.size() - 1).get(\"if_end\"))); } while:\nif (word.typeEquals(\"WHILETK\")) { ... codes.add(new PCode(CodeType.LABEL, whileLabels.get(whileLabels.size() - 1).get(\"while\"))); ... analyseCond(\"WHILETK\"); ... codes.add(new PCode(CodeType.JZ, whileLabels.get(whileLabels.size() - 1).get(\"while_end\"))); codes.add(new PCode(CodeType.LABEL, whileLabels.get(whileLabels.size() - 1).get(\"while_block\"))); analyseStmt(); ... codes.add(new PCode(CodeType.JMP, whileLabels.get(whileLabels.size() - 1).get(\"while\"))); codes.add(new PCode(CodeType.LABEL, whileLabels.get(whileLabels.size() - 1).get(\"while_end\"))); whileLabels.remove(whileLabels.size() - 1); } // break if (word.typeEquals(\"BREAKTK\")) { getWord();//break codes.add(new PCode(CodeType.JMP, whileLabels.get(whileLabels.size() - 1).get(\"while_end\"))); ... } // continue if (word.typeEquals(\"CONTINUETK\")) { getWord();//continue codes.add(new PCode(CodeType.JMP, whileLabels.get(whileLabels.size() - 1).get(\"while\"))); ... } After Code Because of some runtime errors and information shortages, I added and removed some Pcode. At the same, there are some new troubles about address pass and short circuit calculation.\nSpecific Code Definition In Operation, push() means put value into the top of the stack. pop() means pop the value from the top of the stack.\nCommon Type CodeType Value1 Value2 Operation LABEL Label_name Set a label VAR Ident_name Declare a variety PUSH Ident_name/Digit push(value1) POP Address Ident_name *value1 = value2 JZ Label_name Jump if stack top is zero JNZ Label_name Jump if stack top is not zero JMP Label_name Jump unconditionally MAIN Main function label FUNC Function label ENDFUNC End of function label PARA Ident_name Type Parameters RET Return value or not Function return CALL Function name Function call RPARA Type Get parameters ready for function call GETINT Get a integer and put it into stack top PRINT String Para num Pop values and print. DIMVAR Ident_name Type Set dimension info for array variety VALUE Ident_name Type Get the variety value ADDRESS Ident_name Type Get the variety address PLACEHOLDER Push something to hold places EXIT Exit CodeType Value1 Value2 Operation ADD + SUB - MUL * DIV / MOD % CMPEQ == CMPNE != CMPGT \u003e CMPLT \u003c CMPGE \u003e= CMPLE \u003c= AND \u0026\u0026 OR || NOT ! NEG - POS + short circuit calculation There are two situations I need to use short circuit calculation :\n1. if(a\u0026\u0026b) // a is false 2. if(a||b) // b is true This seems not an easy thing and I acutally spent lots of time to solve it.\nMy method is as follows:\nFirst, when I analyze analyseLOrExp, every analyseLAndExp will be followed by a JNZ, which is used for detect if the cond is false. If it is, jump to the if body label. At the same time, I generated cond label, which is ready for the analyseLAndExp.\nprivate void analyseLOrExp(ArrayList\u003cWord\u003e exp, String from) { ... for (...) { ... String label = labelGenerator.getLabel(\"cond_\" + i); analyseLAndExp(exp1, from, label); codes.add(new PCode(CodeType.LABEL, label)); if (...) { codes.add(new PCode(CodeType.OR)); } if (...) { if (...) { codes.add(new PCode(CodeType.JNZ, ifLabels.get(ifLabels.size() - 1).get(\"if_block\"))); } ... } ... } } In the analyseLAndExp, every analyseEqExp will be followed by a JZ, which is used for detect if the cond is true. If it is, jump to the cond label I set just now.\nprivate void analyseLAndExp(ArrayList\u003cWord\u003e exp, String from, String label) { ... for (...) { ... analyseEqExp(exp1); if (...) { codes.add(new PCode(CodeType.AND)); } if (...) { if (...) { codes.add(new PCode(CodeType.JZ, label)); } ... } } } By these means, short circuit calculation is solved.\nSummary ![[编译实验总结感想]]\nReference https://www.bookstack.cn/read/pandolia-tinyc/about.md\n",
  "wordCount" : "3623",
  "inLanguage": "en",
  "image":"https://pic.mcac.cc/202212310105664.png","datePublished": "2021-11-16T16:29:00Z",
  "dateModified": "2021-11-16T16:29:00Z",
  "author":{
    "@type": "Person",
    "name": "SOTO"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://zzhgo.com/posts/projects/alxa_compiler/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "SOTO-BLOG",
    "logo": {
      "@type": "ImageObject",
      "url": "https://zzhgo.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://zzhgo.com/" accesskey="h" title="SOTO (Alt + H)">
                <img src="https://zzhgo.com/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">SOTO</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://zzhgo.com/archives/" title="Archives">
                    <span>Archives</span>
                </a>
            </li>
            <li>
                <a href="https://zzhgo.com/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Alxa_Compiler(SysY to PCODE)
    </h1>
    <div class="post-meta"><span title='2021-11-16 16:29:00 +0000 UTC'>2021-11-16</span>&nbsp;·&nbsp;SOTO

</div>
  </header> 
<figure class="entry-cover"><img loading="lazy" src="https://pic.mcac.cc/202212310105664.png" alt="">
        
</figure><div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#lexical-analysis" aria-label="Lexical analysis">Lexical analysis</a><ul>
                        
                <li>
                    <a href="#before-code" aria-label="Before Code">Before Code</a><ul>
                        
                <li>
                    <a href="#file-reading" aria-label="File reading">File reading</a></li>
                <li>
                    <a href="#analyse" aria-label="Analyse">Analyse</a><ul>
                        
                <li>
                    <a href="#common" aria-label="Common">Common</a></li>
                <li>
                    <a href="#function" aria-label="Function">Function</a></li>
                <li>
                    <a href="#digit-and-letter" aria-label="Digit and Letter">Digit and Letter</a></li></ul>
                </li>
                <li>
                    <a href="#word" aria-label="Word">Word</a></li></ul>
                </li>
                <li>
                    <a href="#after-code" aria-label="After Code">After Code</a><ul>
                        
                <li>
                    <a href="#file-reading-1" aria-label="File reading">File reading</a></li>
                <li>
                    <a href="#analyse-1" aria-label="Analyse">Analyse</a><ul>
                        
                <li>
                    <a href="#slash" aria-label="Slash">Slash</a></li></ul>
                </li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#grammatical-analysis" aria-label="Grammatical analysis">Grammatical analysis</a><ul>
                        
                <li>
                    <a href="#before-code-1" aria-label="Before Code">Before Code</a><ul>
                        
                <li>
                    <a href="#data-reading" aria-label="Data Reading">Data Reading</a></li>
                <li>
                    <a href="#recursive-descent" aria-label="recursive descent">recursive descent</a></li>
                <li>
                    <a href="#left-recursion" aria-label="left recursion">left recursion</a></li></ul>
                </li>
                <li>
                    <a href="#after-code-1" aria-label="After Code">After Code</a><ul>
                        
                <li>
                    <a href="#left-recursion-1" aria-label="left recursion">left recursion</a></li>
                <li>
                    <a href="#other-bugs" aria-label="other bugs">other bugs</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#error-handling" aria-label="Error handling">Error handling</a><ul>
                        
                <li>
                    <a href="#before-code-2" aria-label="Before Code">Before Code</a><ul>
                        
                <li>
                    <a href="#create-the-symbol-table" aria-label="Create the symbol table">Create the symbol table</a></li>
                <li>
                    <a href="#errors" aria-label="Errors">Errors</a><ul>
                        
                <li>
                    <a href="#a" aria-label="a"><strong>a</strong></a></li>
                <li>
                    <a href="#b-c" aria-label="b c"><strong>b c</strong></a></li>
                <li>
                    <a href="#d-e" aria-label="d e"><strong>d e</strong></a></li>
                <li>
                    <a href="#f-g" aria-label="f g">f g</a></li>
                <li>
                    <a href="#h" aria-label="h"><strong>h</strong></a></li>
                <li>
                    <a href="#i-j-k" aria-label="i j k"><strong>i j k</strong></a></li>
                <li>
                    <a href="#l" aria-label="l"><strong>l</strong></a></li>
                <li>
                    <a href="#m" aria-label="m"><strong>m</strong></a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#after-code-2" aria-label="After Code">After Code</a><ul>
                        
                <li>
                    <a href="#area" aria-label="Area">Area</a></li>
                <li>
                    <a href="#error-d-and-e" aria-label="Error d and e">Error d and e</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#code-generation" aria-label="Code generation">Code generation</a><ul>
                        
                <li>
                    <a href="#before-code-3" aria-label="Before Code">Before Code</a><ul>
                        
                <li>
                    <a href="#how-does-the-virtual-machine-run" aria-label="How does the virtual machine run">How does the virtual machine run</a></li>
                <li>
                    <a href="#how-to-distinguish-different-variety" aria-label="How to distinguish different variety">How to distinguish different variety</a></li>
                <li>
                    <a href="#specific-code-definition" aria-label="Specific Code Definition">Specific Code Definition</a><ul>
                        
                <li>
                    <a href="#calculation-type" aria-label="Calculation Type">Calculation Type</a></li>
                <li>
                    <a href="#var" aria-label="VAR">VAR</a></li>
                <li>
                    <a href="#dimvar" aria-label="DIMVAR">DIMVAR</a></li>
                <li>
                    <a href="#placeholder" aria-label="PLACEHOLDER">PLACEHOLDER</a></li>
                <li>
                    <a href="#other" aria-label="Other">Other</a></li></ul>
                </li>
                <li>
                    <a href="#function-call-procedure" aria-label="Function call procedure">Function call procedure</a></li>
                <li>
                    <a href="#value-or-address" aria-label="Value or Address">Value or Address</a></li>
                <li>
                    <a href="#code-generate" aria-label="Code Generate">Code Generate</a><ul>
                        
                <li>
                    <a href="#declaration" aria-label="Declaration">Declaration</a></li>
                <li>
                    <a href="#assign-sentence" aria-label="Assign sentence">Assign sentence</a></li>
                <li>
                    <a href="#condition-control-sentence" aria-label="Condition control sentence">Condition control sentence</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#after-code-3" aria-label="After Code">After Code</a><ul>
                        
                <li>
                    <a href="#specific-code-definition-1" aria-label="Specific Code Definition">Specific Code Definition</a><ul>
                        
                <li>
                    <a href="#common-type" aria-label="Common Type">Common Type</a></li></ul>
                </li>
                <li>
                    <a href="#short-circuit-calculation" aria-label="short circuit calculation">short circuit calculation</a></li></ul>
                </li></ul>
                </li>
                <li>
                    <a href="#summary" aria-label="Summary">Summary</a></li>
                <li>
                    <a href="#reference" aria-label="Reference">Reference</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="lexical-analysis">Lexical analysis<a hidden class="anchor" aria-hidden="true" href="#lexical-analysis">#</a></h2>
<h3 id="before-code">Before Code<a hidden class="anchor" aria-hidden="true" href="#before-code">#</a></h3>
<p>Requriement:  read <code>testfile.txt</code>, parse every char to word and print them. At the same time, memorize type, content and line number of  each word.</p>
<h4 id="file-reading">File reading<a hidden class="anchor" aria-hidden="true" href="#file-reading">#</a></h4>
<p>Read by line, scan every char of every string and analyse.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">while</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">	<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="analyse">Analyse<a hidden class="anchor" aria-hidden="true" href="#analyse">#</a></h4>
<p>When i get the key word, enter the next analyst.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">while</span> <span class="o">((</span><span class="n">c</span> <span class="o">=</span> <span class="n">getChar</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39; &#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\r&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\t&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">words</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Word</span><span class="o">(</span><span class="n">c</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseSlash</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;(&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;)&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;[&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;]&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;{&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;}&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">words</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Word</span><span class="o">(</span><span class="n">c</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;&lt;&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;!&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseRelation</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;,&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">words</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Word</span><span class="o">(</span><span class="n">c</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;&#34;&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseCitation</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;&amp;&#39;</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;|&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseLogic</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">Character</span><span class="o">.</span><span class="na">isDigit</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseDigit</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">Character</span><span class="o">.</span><span class="na">isLetter</span><span class="o">(</span><span class="n">c</span><span class="o">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;_&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseLetter</span><span class="o">(</span><span class="n">c</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="common">Common<a hidden class="anchor" aria-hidden="true" href="#common">#</a></h5>
<p>For example, when I get &lsquo;+&rsquo;, I directly new a Word typify the &ldquo;PLUS&rdquo;.</p>
<h5 id="function">Function<a hidden class="anchor" aria-hidden="true" href="#function">#</a></h5>
<p>For example</p>
<p>When I get <code>&lt;</code> , enter function<code>analyseRelation</code> read one char more. If it is<code>=</code>, analyze <code>LEQ</code>&hellip;</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;&lt;&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">c</span> <span class="o">=</span> <span class="n">getChar</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;=&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">words</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Word</span><span class="o">(</span><span class="s">&#34;&lt;=&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">unGetChar</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">words</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">Word</span><span class="o">(</span><span class="s">&#34;&lt;&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span></code></pre></div><p><code>analyseLogic</code> is as the same.</p>
<h5 id="digit-and-letter">Digit and Letter<a hidden class="anchor" aria-hidden="true" href="#digit-and-letter">#</a></h5>
<p>Digit: When I get a digit, it means I will scan a serial of some digits and turn them into a Word typify &ldquo;INTCON&rdquo;.</p>
<p>Letter: When I get a letter, it means I will scan a string about letter or digit. It maybe a &ldquo;IDENFR&rdquo; or &ldquo;STRCON&rdquo;, which depends on whether it is in key map or not.</p>
<h4 id="word">Word<a hidden class="anchor" aria-hidden="true" href="#word">#</a></h4>
<p>class Word:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Word</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">identification</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">content</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Capsulate the initial function, I only need to <code>new Word(...)</code> in the main processor, which will create the corresponding word.</p>
<p>For example</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">Word</span><span class="o">(</span><span class="kt">char</span> <span class="n">identification</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">identification</span> <span class="o">=</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">identification</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">type</span> <span class="o">=</span> <span class="k">new</span> <span class="n">KeyWordMap</span><span class="o">().</span><span class="na">getType</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">identification</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">.</span><span class="na">content</span> <span class="o">=</span> <span class="k">this</span><span class="o">.</span><span class="na">identification</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>As for KeyWordMap, it is a HashMap, mapping the string of word and its type.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">public</span> <span class="nf">KeyWordMap</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">keyWords</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="n">keyWords</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;main&#34;</span><span class="o">,</span> <span class="s">&#34;MAINTK&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">keyWords</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;const&#34;</span><span class="o">,</span> <span class="s">&#34;CONSTTK&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">keyWords</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;int&#34;</span><span class="o">,</span> <span class="s">&#34;INTTK&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span></code></pre></div><h3 id="after-code">After Code<a hidden class="anchor" aria-hidden="true" href="#after-code">#</a></h3>
<h4 id="file-reading-1">File reading<a hidden class="anchor" aria-hidden="true" href="#file-reading-1">#</a></h4>
<p>Read file by line is not convenient for preread and undo, so I read the file into a single String at first.</p>
<p>The method is read by line, add <code>\n</code> after every line and scan every char. When I get <code>\n</code>, <code>lineNum++</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="nf">transferFileToCode</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">BufferedReader</span> <span class="n">bf</span> <span class="o">=</span> <span class="k">new</span> <span class="n">BufferedReader</span><span class="o">(</span><span class="n">reader</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">StringBuffer</span> <span class="n">buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">s</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">((</span><span class="n">s</span> <span class="o">=</span> <span class="n">bf</span><span class="o">.</span><span class="na">readLine</span><span class="o">())</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">buffer</span><span class="o">.</span><span class="na">append</span><span class="o">(</span><span class="n">s</span><span class="o">).</span><span class="na">append</span><span class="o">(</span><span class="s">&#34;\n&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">buffer</span><span class="o">.</span><span class="na">toString</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h4 id="analyse-1">Analyse<a hidden class="anchor" aria-hidden="true" href="#analyse-1">#</a></h4>
<p>About analyst, it is different from what before coding.</p>
<p>First, I need analyze word one by one, so I add global variety <code>index</code> to memorize where is the pointer.</p>
<p>Besides, I met the situation that I need read one more or undo, so I  encapsulate the function <code>ungetChar</code> and <code>getChar</code>, which will be convenient for me to analyze.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Character</span> <span class="nf">getChar</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">code</span><span class="o">.</span><span class="na">length</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">lineNum</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="n">index</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">c</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">unGetChar</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">index</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">index</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">lineNum</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h5 id="slash">Slash<a hidden class="anchor" aria-hidden="true" href="#slash">#</a></h5>
<ol>
<li><code>//</code> : When it comes to <code>\n</code> , stop.</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">c</span> <span class="o">=</span> <span class="n">getChar</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// 判断为//注释，结束分析
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span></code></pre></div><ol start="2">
<li><code>/* */</code>: Get char until <code>*/</code> appears</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">do</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">c</span> <span class="o">=</span> <span class="n">getChar</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">c</span> <span class="o">=</span> <span class="n">getChar</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 判断为/* */注释，直接结束分析
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">unGetChar</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">);</span>
</span></span></code></pre></div><h2 id="grammatical-analysis">Grammatical analysis<a hidden class="anchor" aria-hidden="true" href="#grammatical-analysis">#</a></h2>
<p>Requirement: Based on the words identified by the lexical analysis program, identify various grammatical elements according to the grammatical rules. Recursive descent method is used to analyze the grammatical components defined in the grammar.</p>
<h3 id="before-code-1">Before Code<a hidden class="anchor" aria-hidden="true" href="#before-code-1">#</a></h3>
<h4 id="data-reading">Data Reading<a hidden class="anchor" aria-hidden="true" href="#data-reading">#</a></h4>
<p>Like the lexical analyst, I prepared function  <code>getWord</code> <code>getNextWord</code> and so on. At the same time, there is a global variety <code>(Word) curWord</code> to display which word it is when I read <code>ArrayList&lt;Word&gt; words </code> from lexical analyst one by one.</p>
<p>My analyst tragedy is as follows:</p>
<p>To normal rule: I keep getting words and analyze them</p>
<p>To expression rule: I scan the whole expression first, which is implemented by function <code>getExp</code>. Then I divide the expression and use method recursive descent to analyze them.</p>
<p><code>getExp</code> like</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="nf">getExp</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">word</span> <span class="n">is</span> <span class="n">symbol</span> <span class="n">of</span> <span class="n">end</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">            <span class="o">...</span>
</span></span><span class="line"><span class="cl">            <span class="n">getWordWithoutAddToGrammar</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">            <span class="n">exp</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">curWord</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">word</span> <span class="o">=</span> <span class="n">getNextWord</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">exp</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h4 id="recursive-descent">recursive descent<a hidden class="anchor" aria-hidden="true" href="#recursive-descent">#</a></h4>
<p>According to Grammatical Rules, code function for every term of rule.</p>
<p>Main idea: read a word, check what it symbolize and enter the next analyzing function.</p>
<p>For example:</p>
<p>to</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">CompUnit</span> <span class="err">→</span> <span class="p">{</span><span class="n">Decl</span><span class="p">}</span> <span class="p">{</span><span class="n">FuncDef</span><span class="p">}</span> <span class="n">MainFuncDef</span> <span class="c1">// 1.是否存在Decl 2.是否存在 FuncDef
</span></span></span></code></pre></div><p>I analyze like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">analyseCompUnit</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Word</span> <span class="n">word</span> <span class="o">=</span> <span class="n">getNextWord</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;CONSTTK&#34;</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;INTTK&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">getNext2Word</span><span class="o">().</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;IDENFR&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">getNext3Word</span><span class="o">().</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;LPARENT&#34;</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseDecl</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">word</span> <span class="o">=</span> <span class="n">getNextWord</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;VOIDTK&#34;</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span>
</span></span><span class="line"><span class="cl">    <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;INTTK&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">getNext2Word</span><span class="o">().</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;MAINTK&#34;</span><span class="o">))))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseFuncDef</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">word</span> <span class="o">=</span> <span class="n">getNextWord</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;INTTK&#34;</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">getNext2Word</span><span class="o">().</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;MAINTK&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseMainFuncDef</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">error</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">grammar</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;&lt;CompUnit&gt;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>grammar is used for memorize output of lexical analyst and grammar analyst list.</p>
<h4 id="left-recursion">left recursion<a hidden class="anchor" aria-hidden="true" href="#left-recursion">#</a></h4>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="err">加减表达式</span> <span class="n">AddExp</span> <span class="err">→</span> <span class="n">MulExp</span> <span class="o">|</span> <span class="n">AddExp</span> <span class="o">(</span><span class="sc">&#39;+&#39;</span> <span class="o">|</span> <span class="sc">&#39;−&#39;</span><span class="o">)</span> <span class="n">MulExp</span> <span class="c1">// 1.MulExp 2.+ 需覆盖 3.- 需覆盖
</span></span></span></code></pre></div><p>Check if the exp has &lsquo;+&rsquo; or &lsquo;-&rsquo;. If it has, separate the exp to AddExp and  MulExp. Then analyze them separately.</p>
<h3 id="after-code-1">After Code<a hidden class="anchor" aria-hidden="true" href="#after-code-1">#</a></h3>
<h4 id="left-recursion-1">left recursion<a hidden class="anchor" aria-hidden="true" href="#left-recursion-1">#</a></h4>
<p>The method used before is not perfect for recursive descent. So I changed my rewrite way.</p>
<p>to</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="err">加减表达式</span> <span class="n">AddExp</span> <span class="err">→</span> <span class="n">MulExp</span> <span class="o">|</span> <span class="nf">AddExp</span> <span class="p">(</span><span class="sc">&#39;+&#39;</span> <span class="o">|</span> <span class="sc">&#39;−&#39;</span><span class="p">)</span> <span class="n">MulExp</span> <span class="c1">// 1.MulExp 2.+ 需覆盖 3.- 需覆盖
</span></span></span></code></pre></div><p>Rewrite it like</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">AddExp</span> <span class="err">→</span> <span class="nf">MulExp</span> <span class="p">(</span><span class="sc">&#39;+&#39;</span> <span class="o">|</span> <span class="sc">&#39;−&#39;</span><span class="p">)</span> <span class="nf">MulExp</span>  <span class="p">(</span><span class="sc">&#39;+&#39;</span> <span class="o">|</span> <span class="sc">&#39;−&#39;</span><span class="p">)</span> <span class="n">MulExp</span> <span class="p">...</span>
</span></span></code></pre></div><p>Code like</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">analyseMulExp</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">exp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">Exps</span> <span class="n">exps</span> <span class="o">=</span> <span class="n">divideExp</span><span class="o">(</span><span class="n">exp</span><span class="o">,</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;(</span><span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">&#34;MULT&#34;</span><span class="o">,</span> <span class="s">&#34;DIV&#34;</span><span class="o">,</span> <span class="s">&#34;MOD&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">exp1</span> <span class="o">:</span> <span class="n">exps</span><span class="o">.</span><span class="na">getWords</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseUnaryExp</span><span class="o">(</span><span class="n">exp1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">grammar</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;&lt;MulExp&gt;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="n">exps</span><span class="o">.</span><span class="na">getSymbols</span><span class="o">().</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">grammar</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">exps</span><span class="o">.</span><span class="na">getSymbols</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">j</span><span class="o">++).</span><span class="na">toString</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Function <code>divideExp</code> is used for divide the whole exp passed by <code>getExp</code> or the pre function.</p>
<p><code>divideExp</code>:</p>
<p>In: orignal: <code>exp</code> stop symbol:  <code>symbol</code></p>
<p>Out: List of divided exp and symbol.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="n">Exps</span> <span class="nf">divideExp</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">exp</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">symbol</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;&gt;</span> <span class="n">exps</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">  <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">exp1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">  <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">symbols</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">  <span class="kt">boolean</span> <span class="n">unaryFlag</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">flag1</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">flag2</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">exp</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Word</span> <span class="n">word</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;LPARENT&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">flag1</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;RPARENT&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">flag1</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;LBRACK&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">flag2</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;RBRACK&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">flag2</span><span class="o">--;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">symbol</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">getType</span><span class="o">())</span> <span class="o">&amp;&amp;</span> <span class="n">flag1</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">flag2</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//UnaryOp
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeOfUnary</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">unaryFlag</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">exp1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">          <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">exps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">exp1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">symbols</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">exp1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">exp1</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">unaryFlag</span> <span class="o">=</span> <span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;IDENFR&#34;</span><span class="o">)</span> <span class="o">||</span> <span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;RPARENT&#34;</span><span class="o">)</span> <span class="o">||</span> <span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;INTCON&#34;</span><span class="o">)</span> <span class="o">||</span> <span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;RBRACK&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">exps</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">exp1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="k">new</span> <span class="n">Exps</span><span class="o">(</span><span class="n">exps</span><span class="o">,</span> <span class="n">symbols</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p><code>Exps</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Exps</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;&gt;</span> <span class="n">words</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">symbols</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="other-bugs">other bugs<a hidden class="anchor" aria-hidden="true" href="#other-bugs">#</a></h4>
<p>Most bugs are produced by function <code>getExp</code> and <code>divideExp</code> because of some situations are ignored. So I always get something like index out of range&hellip;</p>
<p>So I changed some symbol of stop getting expression and modify the rules to divide or not the expression and so on.</p>
<h2 id="error-handling">Error handling<a hidden class="anchor" aria-hidden="true" href="#error-handling">#</a></h2>
<p>Official errors defination</p>
<p><img loading="lazy" src="https://pic.mcac.cc/soto/202112301422547.png" alt=""  />
</p>
<h3 id="before-code-2">Before Code<a hidden class="anchor" aria-hidden="true" href="#before-code-2">#</a></h3>
<h4 id="create-the-symbol-table">Create the symbol table<a hidden class="anchor" aria-hidden="true" href="#create-the-symbol-table">#</a></h4>
<p>Symbol class</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Symbol</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">intType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">content</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">area</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Type means the type of the symbol.</p>
<p>IntType is an integer. If it&rsquo;s 0, the symbol is int. if it&rsquo;s 1, the symbol is int[],  if it&rsquo;s 2, the symbol is int[] []&hellip;</p>
<p>Content is its content.</p>
<p>Area is where is it.</p>
<p>I create a HashMap of Symbols, memorizing symbols created in each area.</p>
<p>When I enter a new area, area++. When I leave an area, area&ndash;, with the corresponding Symbols are destroyed.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">Symbols</span><span class="o">&gt;</span> <span class="n">symbols</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">Function</span><span class="o">&gt;</span> <span class="n">functions</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Error</span><span class="o">&gt;</span> <span class="n">errors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">area</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">needReturn</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">whileFlag</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span></code></pre></div><p><code>needReturn</code> means if the current function need to return.</p>
<p><code>whileFlag </code> means if the current code block is in while circle.</p>
<h4 id="errors">Errors<a hidden class="anchor" aria-hidden="true" href="#errors">#</a></h4>
<h5 id="a"><strong>a</strong><a hidden class="anchor" aria-hidden="true" href="#a">#</a></h5>
<p>Just check format</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">isFormatIllegal</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">content</span><span class="o">.</span><span class="na">length</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(!</span><span class="n">isLegal</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;%&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">content</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">==</span> <span class="sc">&#39;d&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">continue</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">content</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">!=</span> <span class="sc">&#39;n&#39;</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">isLegal</span><span class="o">(</span><span class="kt">char</span> <span class="n">c</span><span class="o">)</span> <span class="o">{</span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">32</span> <span class="o">||</span> <span class="n">c</span> <span class="o">==</span> <span class="mi">33</span> <span class="o">||</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="mi">40</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="mi">126</span><span class="o">);</span> <span class="c1">//offical defination
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">}</span>
</span></span></code></pre></div><h5 id="b-c"><strong>b c</strong><a hidden class="anchor" aria-hidden="true" href="#b-c">#</a></h5>
<p>B: Every time I get an identity, check if there is the same symbol has been defined in this area.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">hasSymbolInThisArea</span><span class="o">(</span><span class="n">Word</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">symbols</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">area</span><span class="o">).</span><span class="na">hasSymbol</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> 
</span></span></code></pre></div><p>C: Check all area. If the symbol has been defined. Functions are as the same.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">hasSymbol</span><span class="o">(</span><span class="n">Word</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="n">Symbols</span> <span class="n">s</span> <span class="o">:</span> <span class="n">symbols</span><span class="o">.</span><span class="na">values</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="na">hasSymbol</span><span class="o">(</span><span class="n">word</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h5 id="d-e"><strong>d e</strong><a hidden class="anchor" aria-hidden="true" href="#d-e">#</a></h5>
<p>To check if the function parameters are matched, I memorize parameters of every function and when I met a function call, I will scan the function call parameters and match them. I prepare a function to do this. Finally I found I need to use recursive descent again, so I add the check procedure to the recursive descent of the grammatical analyst. Please check the <code>After Code/Error d and e</code></p>
<h5 id="f-g">f g<a hidden class="anchor" aria-hidden="true" href="#f-g">#</a></h5>
<p>There is a global variety <code>needReturn</code> used to display if the current function need return. if it does but there is no return in the end of the code block, or if it doesn&rsquo;t but there is return, the error will be memorized.</p>
<h5 id="h"><strong>h</strong><a hidden class="anchor" aria-hidden="true" href="#h">#</a></h5>
<p>Just check if it is a const.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">isConst</span><span class="o">(</span><span class="n">word</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">error</span><span class="o">(</span><span class="s">&#34;h&#34;</span><span class="o">,</span> <span class="n">word</span><span class="o">.</span><span class="na">getLineNum</span><span class="o">());</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="i-j-k"><strong>i j k</strong><a hidden class="anchor" aria-hidden="true" href="#i-j-k">#</a></h5>
<p>Capsulate function about checking missing of the symbol</p>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkParent</span><span class="o">()</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">getNextWord</span><span class="o">().</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;RPARENT&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">getWord</span><span class="o">();</span><span class="c1">// )
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">error</span><span class="o">(</span><span class="s">&#34;j&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h5 id="l"><strong>l</strong><a hidden class="anchor" aria-hidden="true" href="#l">#</a></h5>
<p>Count the number of the parameters of string and printf separately and check if they equal.</p>
<h5 id="m"><strong>m</strong><a hidden class="anchor" aria-hidden="true" href="#m">#</a></h5>
<p>There is a global variety <code>whileFlag</code> symbolize if the code block is in while circle. If it isn&rsquo;t, any continue and break will produce error.</p>
<h3 id="after-code-2">After Code<a hidden class="anchor" aria-hidden="true" href="#after-code-2">#</a></h3>
<h4 id="area">Area<a hidden class="anchor" aria-hidden="true" href="#area">#</a></h4>
<p>I mark the area++ when I get a block or a function, but it will lead to the situation that when enter a code block of a function, the parameters of the function can&rsquo;t be memorize in the different are with the block of the function. So I changed the rules to mark area++.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">analyseBlock</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">fromFunc</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(!</span><span class="n">fromFunc</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">addArea</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>Only when the block is not from the function, the area++.</p>
<h4 id="error-d-and-e">Error d and e<a hidden class="anchor" aria-hidden="true" href="#error-d-and-e">#</a></h4>
<p>To check if the function parameters are matched, I set an array for every function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Function</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">type</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">content</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">String</span> <span class="n">returnType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">paras</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>When I get a function, I memorize its return type and paras.</p>
<p>As for the <code>ArrayList&lt;Integer&gt; paras</code>, it reflects as follows:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Example</th>
<th>Integer</th>
</tr>
</thead>
<tbody>
<tr>
<td>Void</td>
<td></td>
<td>-1</td>
</tr>
<tr>
<td>Int</td>
<td>a</td>
<td>0</td>
</tr>
<tr>
<td>Int[]</td>
<td>a[]</td>
<td>1</td>
</tr>
<tr>
<td>Int[] []</td>
<td>a[] [3]</td>
<td>2</td>
</tr>
</tbody>
</table>
<p>So when I get a function call, I will check the parameter of it with what I have memorized before.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">checkParasMatchRParas</span><span class="o">(</span><span class="n">Word</span> <span class="n">ident</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">paras</span><span class="o">,</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">&gt;</span> <span class="n">rparas</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">paras</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">!=</span> <span class="n">rparas</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">error</span><span class="o">(</span><span class="s">&#34;d&#34;</span><span class="o">,</span> <span class="n">ident</span><span class="o">.</span><span class="na">getLineNum</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">paras</span><span class="o">.</span><span class="na">size</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(!</span><span class="n">paras</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="n">rparas</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">)))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">error</span><span class="o">(</span><span class="s">&#34;e&#34;</span><span class="o">,</span> <span class="n">ident</span><span class="o">.</span><span class="na">getLineNum</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>As for getting the parameters real type, I add the analyst procedure to the recursive descent of the grammatical analyst. Just like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">analyseExp</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">exp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">intType</span> <span class="o">=</span> <span class="n">analyseAddExp</span><span class="o">(</span><span class="n">exp</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">grammar</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="s">&#34;&lt;Exp&gt;&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">intType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><p>Every recursion will return an <code>intType</code>, which symbolize the final type of the expression.</p>
<p>Because the terms of one expression must be the same type, so I return only one of them.</p>
<p>This is the exit of the recursion. It will return a correct type of the expression to the top of the function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="nf">analyseLVal</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">exp</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">intType</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;LBRACK&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                    <span class="n">intType</span><span class="o">++;</span>
</span></span><span class="line"><span class="cl">                    <span class="o">...</span>
</span></span><span class="line"><span class="cl">                <span class="o">}</span>
</span></span><span class="line"><span class="cl">         <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(</span><span class="n">hasSymbol</span><span class="o">(</span><span class="n">ident</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">getSymbol</span><span class="o">(</span><span class="n">ident</span><span class="o">).</span><span class="na">getIntType</span><span class="o">()</span> <span class="o">-</span> <span class="n">intType</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span></code></pre></div><h2 id="code-generation">Code generation<a hidden class="anchor" aria-hidden="true" href="#code-generation">#</a></h2>
<p>In this part, I chose to generate Pcode.</p>
<p>I designed a type of Pcode which is an Inverse Bolan expression stack and symbol table based virtual code.</p>
<p>At the same time, I designed virtual machine to execute them.</p>
<p>The Pcode virtual machine is an imaginary machine used to run Pcode commands. It consists of: A code area (code), an instruction pointer (EIP), a stack, a var_table, a func_table and a label_table.</p>
<p>In the following passage, I will introduce how Pcode executes first and how to produce Pcode next.</p>
<h3 id="before-code-3">Before Code<a hidden class="anchor" aria-hidden="true" href="#before-code-3">#</a></h3>
<h4 id="how-does-the-virtual-machine-run">How does the virtual machine run<a hidden class="anchor" aria-hidden="true" href="#how-does-the-virtual-machine-run">#</a></h4>
<p>First, we need a <code>codes</code> list and a <code>stack</code>(int).</p>
<p>An <code>eip</code>: presents the address of current running code.</p>
<p>A <code>varTable</code>: memorizes the address of the variety in stack.</p>
<p>A <code>funcTable</code>: memorizes the address of the function in codes list.</p>
<p>A <code>labelTable</code>: Memorizes the address of the label in codes list.</p>
<p>Then, run the code one after another and manage the stack.</p>
<h4 id="how-to-distinguish-different-variety">How to distinguish different variety<a hidden class="anchor" aria-hidden="true" href="#how-to-distinguish-different-variety">#</a></h4>
<p>Before generate codes, differentiate varieties from different scopes by its only scope number, like: <code>areaID + &quot;_&quot; + curWord.getContent()</code>. In this situation, the variety will not appear more than once in codes, except for recursive function call, which will be solved by push <code>varTable</code> to stack(show later).</p>
<h4 id="specific-code-definition">Specific Code Definition<a hidden class="anchor" aria-hidden="true" href="#specific-code-definition">#</a></h4>
<p>First, define a class for PCode:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PCode</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">CodeType</span> <span class="n">type</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Object</span> <span class="n">value1</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="n">Object</span> <span class="n">value2</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>It presents one code object, which has a CodeType and two operating values. CodeType is an enum. Value1 and value2 maybe Integer or String or null, which depends on specific code type.</p>
<h5 id="calculation-type">Calculation Type<a hidden class="anchor" aria-hidden="true" href="#calculation-type">#</a></h5>
<p>Two operators:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">b</span> <span class="o">=</span> <span class="n">pop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">a</span> <span class="o">=</span> <span class="n">pop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl"><span class="n">push</span><span class="o">(</span><span class="n">cal</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">));</span>
</span></span></code></pre></div><p>Single operator:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">push</span><span class="o">(</span><span class="n">cal</span><span class="o">(</span><span class="n">pop</span><span class="o">()));</span>
</span></span></code></pre></div><h5 id="var">VAR<a hidden class="anchor" aria-hidden="true" href="#var">#</a></h5>
<p><strong>VAR</strong> command to declare a variable, save the variable name and the address assigned to it in the variable table.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span> <span class="n">VAR</span><span class="o">:</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Var</span> <span class="n">var</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Var</span><span class="o">(</span><span class="n">stack</span><span class="o">.</span><span class="na">size</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">varTable</span><span class="o">.</span><span class="na">put</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue1</span><span class="o">(),</span> <span class="n">var</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Var.class:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Var</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">index</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">dimension</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">dim1</span><span class="o">;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">private</span> <span class="kt">int</span> <span class="n">dim2</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="dimvar">DIMVAR<a hidden class="anchor" aria-hidden="true" href="#dimvar">#</a></h5>
<p><strong>DIMVAR</strong> command to declare an array. Set the dimension information of the var.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span> <span class="n">DIMVAR</span><span class="o">:</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Var</span> <span class="n">var</span> <span class="o">=</span> <span class="n">getVar</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue1</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">var</span><span class="o">.</span><span class="na">setDimension</span><span class="o">(</span><span class="n">n</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">var</span><span class="o">.</span><span class="na">setDim1</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="n">pop</span><span class="o">(),</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pop</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">var</span><span class="o">.</span><span class="na">setDim1</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">var</span><span class="o">.</span><span class="na">setDim2</span><span class="o">(</span><span class="n">j</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="placeholder">PLACEHOLDER<a hidden class="anchor" aria-hidden="true" href="#placeholder">#</a></h5>
<p><strong>PLACEHOLDER</strong> command to grow the stack down, allocate the new space to the variety and array.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span> <span class="n">PLACEHOLDER</span><span class="o">:</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Var</span> <span class="n">var</span> <span class="o">=</span> <span class="n">getVar</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue1</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">push</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">.</span><span class="na">getDim1</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">push</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">2</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">.</span><span class="na">getDim1</span><span class="o">()</span> <span class="o">*</span> <span class="n">var</span><span class="o">.</span><span class="na">getDim2</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">push</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h5 id="other">Other<a hidden class="anchor" aria-hidden="true" href="#other">#</a></h5>
<p>Calculation type: pop the stack top once or twice, calculate them and push again.</p>
<p>Jump Type: When it&rsquo;s command about jump, just check if the condition is satisfied and change the <code>eip</code>.</p>
<p>Function call: as follows</p>
<h4 id="function-call-procedure">Function call procedure<a hidden class="anchor" aria-hidden="true" href="#function-call-procedure">#</a></h4>
<p>First, before function call, there will be some parameters to be pushed into the stack. Each will be followed by a <code>RPARA</code> command, which memorize the address of the previous variety.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span> <span class="n">RPARA</span><span class="o">:</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue1</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rparas</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">stack</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">rparas</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">stack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">stack</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Second, function <code>CALL</code>.</p>
<p>Memorize the eip, stack top address, and information about the function(In fact, they will be pushed into stack too). Then update the <code>varTable</code> and <code>eip</code>.  Ready for execute function.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span> <span class="n">CALL</span><span class="o">:</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Func</span> <span class="n">func</span> <span class="o">=</span> <span class="n">funcTable</span><span class="o">.</span><span class="na">get</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue1</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">retInfos</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">RetInfo</span><span class="o">(</span><span class="n">eip</span><span class="o">,</span> <span class="n">varTable</span><span class="o">,</span> <span class="n">stack</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">,</span> <span class="n">func</span><span class="o">.</span><span class="na">getArgs</span><span class="o">(),</span> <span class="n">func</span><span class="o">.</span><span class="na">getArgs</span><span class="o">(),</span> <span class="n">nowArgsNum</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">eip</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="na">getIndex</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">varTable</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;();</span>
</span></span><span class="line"><span class="cl">    <span class="n">callArgsNum</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="na">getArgs</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">nowArgsNum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>Finally, return when it&rsquo;s <code>RET</code></p>
<p>Restore <code>eip</code>, <code>varTable</code> from <code>RetInfo</code>, clear the new information pushed when function in the stack.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span> <span class="n">RET</span><span class="o">:</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue1</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">RetInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">retInfos</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">retInfos</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">eip</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">getEip</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">varTable</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">getVarTable</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">callArgsNum</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">getCallArgsNum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">nowArgsNum</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="na">getNowArgsNum</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">stack</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">getStackPtr</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">info</span><span class="o">.</span><span class="na">getParaNum</span><span class="o">(),</span> <span class="n">stack</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">stack</span><span class="o">.</span><span class="na">subList</span><span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="na">getStackPtr</span><span class="o">()</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">info</span><span class="o">.</span><span class="na">getParaNum</span><span class="o">(),</span> <span class="n">stack</span><span class="o">.</span><span class="na">size</span><span class="o">()).</span><span class="na">clear</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="value-or-address">Value or Address<a hidden class="anchor" aria-hidden="true" href="#value-or-address">#</a></h4>
<p>Push value or address of the variety is an important thing, it depends on what I need, which will be presented when I describe how to generate codes.</p>
<p>The command action is as follows(<code>getAddress</code> is used for get the address of the previous variety ).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">case</span> <span class="n">VALUE</span><span class="o">:</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Var</span> <span class="n">var</span> <span class="o">=</span> <span class="n">getVar</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue1</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">address</span> <span class="o">=</span> <span class="n">getAddress</span><span class="o">(</span><span class="n">var</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">push</span><span class="o">(</span><span class="n">stack</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">address</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="n">ADDRESS</span><span class="o">:</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">Var</span> <span class="n">var</span> <span class="o">=</span> <span class="n">getVar</span><span class="o">((</span><span class="n">String</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue1</span><span class="o">());</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="n">code</span><span class="o">.</span><span class="na">getValue2</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">address</span> <span class="o">=</span> <span class="n">getAddress</span><span class="o">(</span><span class="n">var</span><span class="o">,</span> <span class="n">n</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">push</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><h4 id="code-generate">Code Generate<a hidden class="anchor" aria-hidden="true" href="#code-generate">#</a></h4>
<p>Code generated from the grammatical analyst procedure.</p>
<h5 id="declaration">Declaration<a hidden class="anchor" aria-hidden="true" href="#declaration">#</a></h5>
<p>There is no need to distinguish const and var. When declare a variety, just new a variety and let it point to the stack top. Then if it has an initialization, just push the values one after another. If not, add a <code>PLACEHOLDER</code> command to push something(I push 0) to the stack to hold the place.</p>
<h5 id="assign-sentence">Assign sentence<a hidden class="anchor" aria-hidden="true" href="#assign-sentence">#</a></h5>
<p>In this situation, first calculate and push the address of the variety to the stack top. Then analyze expressions. After that, there are only two number in the stack, which are address and value. Assign the value to the address.</p>
<h5 id="condition-control-sentence">Condition control sentence<a hidden class="anchor" aria-hidden="true" href="#condition-control-sentence">#</a></h5>
<p>First, generate labels. Then, place jump sentences in the proper places.</p>
<p>labels about if and while will be generated and then stored in a stack type structure. like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="n">whileLabels</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;&gt;());</span>
</span></span><span class="line"><span class="cl"><span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;while&#34;</span><span class="o">,</span> <span class="n">labelGenerator</span><span class="o">.</span><span class="na">getLabel</span><span class="o">(</span><span class="s">&#34;while&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;while_end&#34;</span><span class="o">,</span> <span class="n">labelGenerator</span><span class="o">.</span><span class="na">getLabel</span><span class="o">(</span><span class="s">&#34;while_end&#34;</span><span class="o">));</span>
</span></span><span class="line"><span class="cl"><span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">put</span><span class="o">(</span><span class="s">&#34;while_block&#34;</span><span class="o">,</span> <span class="n">labelGenerator</span><span class="o">.</span><span class="na">getLabel</span><span class="o">(</span><span class="s">&#34;while_block&#34;</span><span class="o">));</span>
</span></span></code></pre></div><p>Take if as example:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;IFTK&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">LABEL</span><span class="o">,</span> <span class="n">ifLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ifLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;if&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseCond</span><span class="o">(</span><span class="s">&#34;IFTK&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">JZ</span><span class="o">,</span> <span class="n">ifLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ifLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;else&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">LABEL</span><span class="o">,</span> <span class="n">ifLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ifLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;if_block&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseStmt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">JMP</span><span class="o">,</span> <span class="n">ifLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ifLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;if_end&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">LABEL</span><span class="o">,</span> <span class="n">ifLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ifLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;else&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;ELSETK&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">getWord</span><span class="o">();</span> <span class="c1">//else
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">analyseStmt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">LABEL</span><span class="o">,</span> <span class="n">ifLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ifLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;if_end&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>while:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;WHILETK&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">LABEL</span><span class="o">,</span> <span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;while&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseCond</span><span class="o">(</span><span class="s">&#34;WHILETK&#34;</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">JZ</span><span class="o">,</span> <span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;while_end&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">LABEL</span><span class="o">,</span> <span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;while_block&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyseStmt</span><span class="o">();</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">JMP</span><span class="o">,</span> <span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;while&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">LABEL</span><span class="o">,</span> <span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;while_end&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="n">whileLabels</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// break
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;BREAKTK&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">getWord</span><span class="o">();</span><span class="c1">//break
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">JMP</span><span class="o">,</span> <span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;while_end&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl"> 		<span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// continue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="o">(</span><span class="n">word</span><span class="o">.</span><span class="na">typeEquals</span><span class="o">(</span><span class="s">&#34;CONTINUETK&#34;</span><span class="o">))</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">getWord</span><span class="o">();</span><span class="c1">//continue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">JMP</span><span class="o">,</span> <span class="n">whileLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">whileLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;while&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span> 
</span></span></code></pre></div><h3 id="after-code-3">After Code<a hidden class="anchor" aria-hidden="true" href="#after-code-3">#</a></h3>
<p>Because of some runtime errors and information shortages, I added and removed some Pcode. At the same, there are some new troubles about address pass and short circuit calculation.</p>
<h4 id="specific-code-definition-1">Specific Code Definition<a hidden class="anchor" aria-hidden="true" href="#specific-code-definition-1">#</a></h4>
<p>In Operation, <code>push()</code> means put value into the top of the stack. <code>pop()</code> means pop the value from the top of the stack.</p>
<h5 id="common-type">Common Type<a hidden class="anchor" aria-hidden="true" href="#common-type">#</a></h5>
<table>
<thead>
<tr>
<th>CodeType</th>
<th>Value1</th>
<th>Value2</th>
<th>Operation</th>
</tr>
</thead>
<tbody>
<tr>
<td>LABEL</td>
<td>Label_name</td>
<td>Set  a label</td>
<td></td>
</tr>
<tr>
<td>VAR</td>
<td>Ident_name</td>
<td>Declare  a variety</td>
<td></td>
</tr>
<tr>
<td>PUSH</td>
<td>Ident_name/Digit</td>
<td>push(value1)</td>
<td></td>
</tr>
<tr>
<td>POP</td>
<td>Address</td>
<td>Ident_name</td>
<td>*value1 = value2</td>
</tr>
<tr>
<td>JZ</td>
<td>Label_name</td>
<td></td>
<td>Jump if stack top is zero</td>
</tr>
<tr>
<td>JNZ</td>
<td>Label_name</td>
<td></td>
<td>Jump if stack top is not zero</td>
</tr>
<tr>
<td>JMP</td>
<td>Label_name</td>
<td></td>
<td>Jump unconditionally</td>
</tr>
<tr>
<td>MAIN</td>
<td></td>
<td></td>
<td>Main function label</td>
</tr>
<tr>
<td>FUNC</td>
<td></td>
<td></td>
<td>Function label</td>
</tr>
<tr>
<td>ENDFUNC</td>
<td></td>
<td></td>
<td>End of function label</td>
</tr>
<tr>
<td>PARA</td>
<td>Ident_name</td>
<td>Type</td>
<td>Parameters</td>
</tr>
<tr>
<td>RET</td>
<td>Return value or not</td>
<td></td>
<td>Function return</td>
</tr>
<tr>
<td>CALL</td>
<td>Function name</td>
<td></td>
<td>Function call</td>
</tr>
<tr>
<td>RPARA</td>
<td>Type</td>
<td></td>
<td>Get parameters ready for function call</td>
</tr>
<tr>
<td>GETINT</td>
<td></td>
<td></td>
<td>Get a integer and put it into stack top</td>
</tr>
<tr>
<td>PRINT</td>
<td>String</td>
<td>Para num</td>
<td>Pop values and print.</td>
</tr>
<tr>
<td>DIMVAR</td>
<td>Ident_name</td>
<td>Type</td>
<td>Set dimension info for array variety</td>
</tr>
<tr>
<td>VALUE</td>
<td>Ident_name</td>
<td>Type</td>
<td>Get the variety value</td>
</tr>
<tr>
<td>ADDRESS</td>
<td>Ident_name</td>
<td>Type</td>
<td>Get the variety address</td>
</tr>
<tr>
<td>PLACEHOLDER</td>
<td></td>
<td></td>
<td>Push something to hold places</td>
</tr>
<tr>
<td>EXIT</td>
<td></td>
<td></td>
<td>Exit</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>CodeType</th>
<th>Value1</th>
<th>Value2</th>
<th>Operation</th>
</tr>
</thead>
<tbody>
<tr>
<td>ADD</td>
<td></td>
<td></td>
<td>+</td>
</tr>
<tr>
<td>SUB</td>
<td></td>
<td></td>
<td>-</td>
</tr>
<tr>
<td>MUL</td>
<td></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td>DIV</td>
<td></td>
<td></td>
<td>/</td>
</tr>
<tr>
<td>MOD</td>
<td></td>
<td></td>
<td>%</td>
</tr>
<tr>
<td>CMPEQ</td>
<td></td>
<td></td>
<td>==</td>
</tr>
<tr>
<td>CMPNE</td>
<td></td>
<td></td>
<td>!=</td>
</tr>
<tr>
<td>CMPGT</td>
<td></td>
<td></td>
<td>&gt;</td>
</tr>
<tr>
<td>CMPLT</td>
<td></td>
<td></td>
<td>&lt;</td>
</tr>
<tr>
<td>CMPGE</td>
<td></td>
<td></td>
<td>&gt;=</td>
</tr>
<tr>
<td>CMPLE</td>
<td></td>
<td></td>
<td>&lt;=</td>
</tr>
<tr>
<td>AND</td>
<td></td>
<td></td>
<td>&amp;&amp;</td>
</tr>
<tr>
<td>OR</td>
<td></td>
<td></td>
<td>||</td>
</tr>
<tr>
<td>NOT</td>
<td></td>
<td></td>
<td>!</td>
</tr>
<tr>
<td>NEG</td>
<td></td>
<td></td>
<td>-</td>
</tr>
<tr>
<td>POS</td>
<td></td>
<td></td>
<td>+</td>
</tr>
</tbody>
</table>
<h4 id="short-circuit-calculation">short circuit calculation<a hidden class="anchor" aria-hidden="true" href="#short-circuit-calculation">#</a></h4>
<p>There are two situations I need to use short circuit calculation :</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="mf">1.</span> <span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="o">&amp;&amp;</span><span class="n">b</span><span class="p">)</span> <span class="c1">// a is false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="mf">2.</span> <span class="k">if</span><span class="p">(</span><span class="n">a</span><span class="o">||</span><span class="n">b</span><span class="p">)</span> <span class="c1">// b is true
</span></span></span></code></pre></div><p>This seems not an easy thing and I acutally spent lots of time to solve it.</p>
<p>My method is as follows:</p>
<p>First, when I analyze <code>analyseLOrExp</code>, every <code>analyseLAndExp</code> will be followed by a <code>JNZ</code>, which is used for detect if the cond is false. If it is, jump to the if body label. At the same time, I generated cond label, which is ready for the <code>analyseLAndExp</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">analyseLOrExp</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">exp</span><span class="o">,</span> <span class="n">String</span> <span class="n">from</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(...)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="n">String</span> <span class="n">label</span> <span class="o">=</span> <span class="n">labelGenerator</span><span class="o">.</span><span class="na">getLabel</span><span class="o">(</span><span class="s">&#34;cond_&#34;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">analyseLAndExp</span><span class="o">(</span><span class="n">exp1</span><span class="o">,</span> <span class="n">from</span><span class="o">,</span> <span class="n">label</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">LABEL</span><span class="o">,</span> <span class="n">label</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(...)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">OR</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(...)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(...)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">JNZ</span><span class="o">,</span> <span class="n">ifLabels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">ifLabels</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="o">-</span> <span class="mi">1</span><span class="o">).</span><span class="na">get</span><span class="o">(</span><span class="s">&#34;if_block&#34;</span><span class="o">)));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span>
</span></span><span class="line"><span class="cl">          <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>In the <code>analyseLAndExp</code>, every <code>analyseEqExp</code> will be followed by a <code>JZ</code>, which is used for detect if the cond is true. If it is, jump to the cond label I set just now.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-java" data-lang="java"><span class="line"><span class="cl"><span class="kd">private</span> <span class="kt">void</span> <span class="nf">analyseLAndExp</span><span class="o">(</span><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Word</span><span class="o">&gt;</span> <span class="n">exp</span><span class="o">,</span> <span class="n">String</span> <span class="n">from</span><span class="o">,</span> <span class="n">String</span> <span class="n">label</span><span class="o">)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="o">(...)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="n">analyseEqExp</span><span class="o">(</span><span class="n">exp1</span><span class="o">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(...)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">AND</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">(...)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="o">(...)</span> <span class="o">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">codes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="k">new</span> <span class="n">PCode</span><span class="o">(</span><span class="n">CodeType</span><span class="o">.</span><span class="na">JZ</span><span class="o">,</span> <span class="n">label</span><span class="o">));</span>
</span></span><span class="line"><span class="cl">            <span class="o">}</span> 
</span></span><span class="line"><span class="cl">          <span class="o">...</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>By these means, short circuit calculation is solved.</p>
<h2 id="summary">Summary<a hidden class="anchor" aria-hidden="true" href="#summary">#</a></h2>
<p>![[编译实验总结感想]]</p>
<h2 id="reference">Reference<a hidden class="anchor" aria-hidden="true" href="#reference">#</a></h2>
<p><a href="https://www.bookstack.cn/read/pandolia-tinyc/about.md">https://www.bookstack.cn/read/pandolia-tinyc/about.md</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://zzhgo.com/tags/buaa/">BUAA</a></li>
      <li><a href="https://zzhgo.com/tags/%E9%A1%B9%E7%9B%AE/">项目</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://zzhgo.com/">SOTO-BLOG</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
    <span>
        |
    </span>
    <span>
        <a href="https://beian.miit.gov.cn/#/Integrated/index" rel="noopener noreferrer" target="_blank">京ICP备2020039419号</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
