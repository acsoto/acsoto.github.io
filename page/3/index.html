<!doctype html>
<html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta><title>SOTO-BLOG</title><link rel="manifest" href="/manifest.json"><meta name="application-name" content="SOTO-BLOG"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="SOTO-BLOG"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="SOTO的博客"><meta property="og:type" content="blog"><meta property="og:title" content="SOTO-BLOG"><meta property="og:url" content="http://atksoto.com/"><meta property="og:site_name" content="SOTO-BLOG"><meta property="og:description" content="SOTO的博客"><meta property="og:locale" content="en_US"><meta property="og:image" content="http://atksoto.com/img/og_image.png"><meta property="article:author" content="soto"><meta property="article:tag" content="随想"><meta property="article:tag" content="编程"><meta property="article:tag" content="生活"><meta property="twitter:card" content="summary"><meta property="twitter:image" content="/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"http://atksoto.com"},"headline":"SOTO-BLOG","image":["http://atksoto.com/img/og_image.png"],"author":{"@type":"Person","name":"soto"},"publisher":{"@type":"Organization","name":"SOTO-BLOG","logo":{"@type":"ImageObject"}},"description":"SOTO的博客"}</script><link rel="icon" href="/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.2/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-light.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;600&amp;family=Source+Code+Pro"><link rel="stylesheet" href="/css/default.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css"><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script><!--!--><!--!--><meta name="generator" content="Hexo 5.4.0"></head><body class="is-2-column"><nav class="navbar navbar-main"><div class="container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/">SOTO-BLOG</a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/">Home</a><a class="navbar-item" href="/archives">Archives</a><a class="navbar-item" href="/categories">Categories</a><a class="navbar-item" href="/tags">Tags</a><a class="navbar-item" href="/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="Search" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-8-widescreen"><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-19T17:53:10.000Z" title="2021/11/20 上午1:53:10">2021-11-20</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.653Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">2 minutes read (About 234 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/27481/">何以变革</a></h1><div class="content"><p>大部分人做着自己不想做的事情，只是为了生存，这点有史以来未曾改变。有人只是爱好，有人只是在追求功利，摆出一副难看的样子，卑微的为了让自己能或许多有一点点微乎其微的可能性，去屈服，痛苦，下跪，丧失着自由。何以变革，或许少部分值得敬佩的，才是异类。</p>
<p>我选择方式越来越趋向于同一个准则，或许是积累了那么多经验，觉得只要这样做才是应该的，才能让自己快乐，当然，这样的选择方式，在遵循的同时，也不失会带来一些焦虑，然后我又去抑制这种焦虑？就不知道是自己在习惯的过程中，还是做错了。</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/posts/22522/"><img class="fill" src="https://tva1.sinaimg.cn/large/008i3skNly1gwocp0mkarj30sg0lc43v.jpg" alt="与鸟巢的匆匆一面"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-19T15:34:01.000Z" title="2021/11/19 下午11:34:01">2021-11-19</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.651Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">4 minutes read (About 586 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/22522/">与鸟巢的匆匆一面</a></h1><div class="content"><p>今赴一场蓄谋已久的生日宴会，开场一个半小时后先行撤退且不辞而别，在此先把责任全部归咎于我自己，母上也对我的行为直呼无趣，倒也不是自讨没趣，只是封校许久难得有机会出来，想要自行去溜达一圈。</p></div><a class="article-more button is-small is-size-7" href="/posts/22522/#more">Read more</a></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-19T02:09:18.000Z" title="2021/11/19 上午10:09:18">2021-11-19</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.663Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">a few seconds read (About 42 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/12888/">Unknown collation- &#039;utf8mb4_0900_ai_ci&#039;</a></h1><div class="content"><p>运行sql脚本时</p>
<p>sql报错如下</p>
<p>Unknown collation: ‘utf8mb4_0900_ai_ci’</p>
<p>原因mySQL版本不兼容，将sql文件中 utf8mb4_0900_ai_ci 替换成 utf8mb4_general_ci </p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/posts/51052/"><img class="fill" src="https://tva1.sinaimg.cn/large/008i3skNly1gwuyxmimj1j30tg0c0wfl.jpg" alt="Alxa_Compiler 编译器"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-16T08:29:00.000Z" title="2021/11/16 下午4:29:00">2021-11-16</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.664Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">24 minutes read (About 3579 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/51052/">Alxa_Compiler 编译器</a></h1><div class="content"><p>相关文章：[[编译实验总结感想]]</p>
<h2 id="词法分析"><a href="#词法分析" class="headerlink" title="词法分析"></a>词法分析</h2><h3 id="Before-Code"><a href="#Before-Code" class="headerlink" title="Before Code"></a>Before Code</h3><p>Requriement:  read <code>testfile.txt</code>, parse every char to word and print them. At the same time, memorize type, content and line number of  each word.</p>
<h4 id="File-reading"><a href="#File-reading" class="headerlink" title="File reading"></a>File reading</h4><p>Read by line, scan every char of every string and analyse.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((s = bf.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analyse"><a href="#Analyse" class="headerlink" title="Analyse"></a>Analyse</h4><p>When i get the key word, enter the next analyst. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ((c = getChar()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27; &#x27;</span> || c == <span class="string">&#x27;\r&#x27;</span> || c == <span class="string">&#x27;\t&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;+&#x27;</span> || c == <span class="string">&#x27;-&#x27;</span> || c == <span class="string">&#x27;*&#x27;</span> || c == <span class="string">&#x27;%&#x27;</span>) &#123;</span><br><span class="line">    words.add(<span class="keyword">new</span> Word(c));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">    analyseSlash();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;(&#x27;</span> || c == <span class="string">&#x27;)&#x27;</span> || c == <span class="string">&#x27;[&#x27;</span> || c == <span class="string">&#x27;]&#x27;</span> || c == <span class="string">&#x27;&#123;&#x27;</span> || c == <span class="string">&#x27;&#125;&#x27;</span>) &#123;</span><br><span class="line">    words.add(<span class="keyword">new</span> Word(c));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;&gt;&#x27;</span> || c == <span class="string">&#x27;&lt;&#x27;</span> || c == <span class="string">&#x27;=&#x27;</span> || c == <span class="string">&#x27;!&#x27;</span>) &#123;</span><br><span class="line">    analyseRelation(c);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;,&#x27;</span> || c == <span class="string">&#x27;;&#x27;</span>) &#123;</span><br><span class="line">    words.add(<span class="keyword">new</span> Word(c));</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;&quot;&#x27;</span>) &#123;</span><br><span class="line">    analyseCitation();</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (c == <span class="string">&#x27;&amp;&#x27;</span> || c == <span class="string">&#x27;|&#x27;</span>) &#123;</span><br><span class="line">    analyseLogic(c);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Character.isDigit(c)) &#123;</span><br><span class="line">    analyseDigit(c);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Character.isLetter(c) || c == <span class="string">&#x27;_&#x27;</span>) &#123;</span><br><span class="line">    analyseLetter(c);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Common"><a href="#Common" class="headerlink" title="Common"></a>Common</h5><p>For example, when I get ‘+’, I directly new a Word typify the “PLUS”.</p>
<h5 id="Function"><a href="#Function" class="headerlink" title="Function"></a>Function</h5><p>For example</p>
<p>When I get <code>&lt;</code> , enter function<code>analyseRelation</code> read one char more. If it is<code>=</code>, analyze <code>LEQ</code>…</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (c == <span class="string">&#x27;&lt;&#x27;</span>) &#123;</span><br><span class="line">  c = getChar();</span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27;=&#x27;</span>) &#123;</span><br><span class="line">    words.add(<span class="keyword">new</span> Word(<span class="string">&quot;&lt;=&quot;</span>));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    unGetChar();</span><br><span class="line">    words.add(<span class="keyword">new</span> Word(<span class="string">&quot;&lt;&quot;</span>));</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p><code>analyseLogic</code> is as the same.</p>
<h5 id="Digit-and-Letter"><a href="#Digit-and-Letter" class="headerlink" title="Digit and Letter"></a>Digit and Letter</h5><p>Digit: When I get a digit, it means I will scan a serial of some digits and turn them into a Word typify “INTCON”.</p>
<p>Letter: When I get a letter, it means I will scan a string about letter or digit. It maybe a “IDENFR” or “STRCON”, which depends on whether it is in key map or not. </p>
<h4 id="Word"><a href="#Word" class="headerlink" title="Word"></a>Word</h4><p>class Word:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Word</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String identification;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Capsulate the initial function, I only need to <code>new Word(...)</code> in the main processor, which will create the corresponding word.</p>
<p>For example</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Word</span><span class="params">(<span class="keyword">char</span> identification)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.identification = String.valueOf(identification);</span><br><span class="line">    <span class="keyword">this</span>.type = <span class="keyword">new</span> KeyWordMap().getType(<span class="keyword">this</span>.identification);</span><br><span class="line">    <span class="keyword">this</span>.content = <span class="keyword">this</span>.identification;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As for KeyWordMap, it is a HashMap, mapping the string of word and its type.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">KeyWordMap</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    keyWords = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    keyWords.put(<span class="string">&quot;main&quot;</span>, <span class="string">&quot;MAINTK&quot;</span>);</span><br><span class="line">    keyWords.put(<span class="string">&quot;const&quot;</span>, <span class="string">&quot;CONSTTK&quot;</span>);</span><br><span class="line">    keyWords.put(<span class="string">&quot;int&quot;</span>, <span class="string">&quot;INTTK&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="After-Code"><a href="#After-Code" class="headerlink" title="After Code"></a>After Code</h3><h4 id="File-reading-1"><a href="#File-reading-1" class="headerlink" title="File reading"></a>File reading</h4><p>Read file by line is not convenient for preread and undo, so I read the file into a single String at first. </p>
<p>The method is read by line, add <code>\n</code> after every line and scan every char. When I get <code>\n</code>, <code>lineNum++</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">transferFileToCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    BufferedReader bf = <span class="keyword">new</span> BufferedReader(reader);</span><br><span class="line">    StringBuffer buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    String s = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> ((s = bf.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">        buffer.append(s).append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> buffer.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Analyse-1"><a href="#Analyse-1" class="headerlink" title="Analyse"></a>Analyse</h4><p>About analyst, it is different from what before coding.</p>
<p>First, I need analyze word one by one, so I add global variety <code>index</code> to memorize where is the pointer. </p>
<p>Besides, I met the situation that I need read one more or undo, so I  encapsulate the function <code>ungetChar</code> and <code>getChar</code>, which will be convenient for me to analyze. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Character <span class="title">getChar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; code.length()) &#123;</span><br><span class="line">        <span class="keyword">char</span> c = code.charAt(index);</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">            lineNum++;</span><br><span class="line">        &#125;</span><br><span class="line">        index++;</span><br><span class="line">        <span class="keyword">return</span> c;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">unGetChar</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    index--;</span><br><span class="line">    <span class="keyword">char</span> c = code.charAt(index);</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">        lineNum--;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Slash"><a href="#Slash" class="headerlink" title="Slash"></a>Slash</h5><ol>
<li><code>//</code> : When it comes to <code>\n</code> , stop.</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  c = getChar();</span><br><span class="line">  <span class="keyword">if</span> (c == <span class="keyword">null</span> || c == <span class="string">&#x27;\n&#x27;</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// 判断为//注释，结束分析</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><code>/* */</code>: Get char until <code>*/</code> appears</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  c = getChar();</span><br><span class="line">  <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (c == <span class="string">&#x27;*&#x27;</span>) &#123;</span><br><span class="line">    c = getChar();</span><br><span class="line">    <span class="keyword">if</span> (c == <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">      <span class="comment">// 判断为/* */注释，直接结束分析</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      unGetChar();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<h2 id="语法分析"><a href="#语法分析" class="headerlink" title="语法分析"></a>语法分析</h2><p>Requirement: Based on the words identified by the lexical analysis program, identify various grammatical elements according to the grammatical rules. Recursive descent method is used to analyze the grammatical components defined in the grammar.</p>
<h3 id="Before-Code-1"><a href="#Before-Code-1" class="headerlink" title="Before Code"></a>Before Code</h3><h4 id="Data-Reading"><a href="#Data-Reading" class="headerlink" title="Data Reading"></a>Data Reading</h4><p>Like the lexical analyst, I prepared function  <code>getWord</code> <code>getNextWord</code> and so on. At the same time, there is a global variety <code>(Word) curWord</code> to display which word it is when I read <code>ArrayList&lt;Word&gt; words </code> from lexical analyst one by one.    </p>
<p>My analyst tragedy is as follows:</p>
<p>To normal rule: I keep getting words and analyze them</p>
<p>To expression rule: I scan the whole expression first, which is implemented by function <code>getExp</code>. Then I divide the expression and use method recursive descent to analyze them.</p>
<p><code>getExp</code> like</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ArrayList&lt;Word&gt; <span class="title">getExp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    ArrayList&lt;Word&gt; exp = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (word is symbol of end) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">        getWordWithoutAddToGrammar();</span><br><span class="line">        exp.add(curWord);</span><br><span class="line">        word = getNextWord();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> exp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="recursive-descent"><a href="#recursive-descent" class="headerlink" title="recursive descent"></a>recursive descent</h4><p>According to Grammatical Rules, code function for every term of rule.</p>
<p>Main idea: read a word, check what it symbolize and enter the next analyzing function.  </p>
<p>For example:</p>
<p>to</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CompUnit → &#123;Decl&#125; &#123;FuncDef&#125; MainFuncDef <span class="comment">// 1.是否存在Decl 2.是否存在 FuncDef</span></span><br></pre></td></tr></table></figure>

<p>I analyze like this:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">analyseCompUnit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Word word = getNextWord();</span><br><span class="line">  <span class="keyword">while</span> (word.typeEquals(<span class="string">&quot;CONSTTK&quot;</span>) || (</span><br><span class="line">    word.typeEquals(<span class="string">&quot;INTTK&quot;</span>) &amp;&amp; getNext2Word().typeEquals(<span class="string">&quot;IDENFR&quot;</span>) &amp;&amp; !getNext3Word().typeEquals(<span class="string">&quot;LPARENT&quot;</span>))) &#123;</span><br><span class="line">    analyseDecl();</span><br><span class="line">    word = getNextWord();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (word.typeEquals(<span class="string">&quot;VOIDTK&quot;</span>) || (</span><br><span class="line">    (word.typeEquals(<span class="string">&quot;INTTK&quot;</span>) &amp;&amp; !getNext2Word().typeEquals(<span class="string">&quot;MAINTK&quot;</span>)))) &#123;</span><br><span class="line">    analyseFuncDef();</span><br><span class="line">    word = getNextWord();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;INTTK&quot;</span>) &amp;&amp; getNext2Word().typeEquals(<span class="string">&quot;MAINTK&quot;</span>)) &#123;</span><br><span class="line">    analyseMainFuncDef();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    error();</span><br><span class="line">  &#125;</span><br><span class="line">  grammar.add(<span class="string">&quot;&lt;CompUnit&gt;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>grammar is used for memorize output of lexical analyst and grammar analyst list. </p>
<h4 id="left-recursion"><a href="#left-recursion" class="headerlink" title="left recursion"></a>left recursion</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">加减表达式 AddExp → MulExp | AddExp (<span class="string">&#x27;+&#x27;</span> | <span class="string">&#x27;−&#x27;</span>) MulExp <span class="comment">// 1.MulExp 2.+ 需覆盖 3.- 需覆盖</span></span><br></pre></td></tr></table></figure>

<p>Check if the exp has ‘+’ or ‘-‘. If it has, separate the exp to AddExp and  MulExp. Then analyze them separately. </p>
<h3 id="After-Code-1"><a href="#After-Code-1" class="headerlink" title="After Code"></a>After Code</h3><h4 id="left-recursion-1"><a href="#left-recursion-1" class="headerlink" title="left recursion"></a>left recursion</h4><p>The method used before is not perfect for recursive descent. So I changed my rewrite way.</p>
<p>to</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">加减表达式 AddExp → MulExp | AddExp (<span class="string">&#x27;+&#x27;</span> | <span class="string">&#x27;−&#x27;</span>) MulExp <span class="comment">// 1.MulExp 2.+ 需覆盖 3.- 需覆盖</span></span><br></pre></td></tr></table></figure>

<p>Rewrite it like </p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddExp → MulExp (<span class="string">&#x27;+&#x27;</span> | <span class="string">&#x27;−&#x27;</span>) MulExp  (<span class="string">&#x27;+&#x27;</span> | <span class="string">&#x27;−&#x27;</span>) MulExp ...</span><br></pre></td></tr></table></figure>

<p>Code like </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">analyseMulExp</span><span class="params">(ArrayList&lt;Word&gt; exp)</span> </span>&#123;</span><br><span class="line">  Exps exps = divideExp(exp, <span class="keyword">new</span> ArrayList&lt;&gt;(Arrays.asList(<span class="string">&quot;MULT&quot;</span>, <span class="string">&quot;DIV&quot;</span>, <span class="string">&quot;MOD&quot;</span>)));</span><br><span class="line">  <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (ArrayList&lt;Word&gt; exp1 : exps.getWords()) &#123;</span><br><span class="line">    analyseUnaryExp(exp1);</span><br><span class="line">    grammar.add(<span class="string">&quot;&lt;MulExp&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (j &lt; exps.getSymbols().size()) &#123;</span><br><span class="line">      grammar.add(exps.getSymbols().get(j++).toString());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Function <code>divideExp</code> is used for divide the whole exp passed by <code>getExp</code> or the pre function.</p>
<p><code>divideExp</code>:</p>
<p>In: orignal: <code>exp</code> stop symbol:  <code>symbol</code></p>
<p>Out: List of divided exp and symbol.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Exps <span class="title">divideExp</span><span class="params">(ArrayList&lt;Word&gt; exp, ArrayList&lt;String&gt; symbol)</span> </span>&#123;</span><br><span class="line">  ArrayList&lt;ArrayList&lt;Word&gt;&gt; exps = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  ArrayList&lt;Word&gt; exp1 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  ArrayList&lt;Word&gt; symbols = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">  <span class="keyword">boolean</span> unaryFlag = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">int</span> flag1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> flag2 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; exp.size(); i++) &#123;</span><br><span class="line">    Word word = exp.get(i);</span><br><span class="line">    <span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;LPARENT&quot;</span>)) &#123;</span><br><span class="line">      flag1++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;RPARENT&quot;</span>)) &#123;</span><br><span class="line">      flag1--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;LBRACK&quot;</span>)) &#123;</span><br><span class="line">      flag2++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;RBRACK&quot;</span>)) &#123;</span><br><span class="line">      flag2--;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (symbol.contains(word.getType()) &amp;&amp; flag1 == <span class="number">0</span> &amp;&amp; flag2 == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">//UnaryOp</span></span><br><span class="line">      <span class="keyword">if</span> (word.typeOfUnary()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!unaryFlag) &#123;</span><br><span class="line">          exp1.add(word);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      exps.add(exp1);</span><br><span class="line">      symbols.add(word);</span><br><span class="line">      exp1 = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      exp1.add(word);</span><br><span class="line">    &#125;</span><br><span class="line">    unaryFlag = word.typeEquals(<span class="string">&quot;IDENFR&quot;</span>) || word.typeEquals(<span class="string">&quot;RPARENT&quot;</span>) || word.typeEquals(<span class="string">&quot;INTCON&quot;</span>) || word.typeEquals(<span class="string">&quot;RBRACK&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  exps.add(exp1);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Exps(exps, symbols);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Exps</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Exps</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;ArrayList&lt;Word&gt;&gt; words;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;Word&gt; symbols;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="other-bugs"><a href="#other-bugs" class="headerlink" title="other bugs"></a>other bugs</h4><p>Most bugs are produced by function <code>getExp</code> and <code>divideExp</code> because of some situations are ignored. So I always get something like index out of range…</p>
<p>So I changed some symbol of stop getting expression and modify the rules to divide or not the expression and so on.</p>
<h2 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h2><h3 id="Before-Code-2"><a href="#Before-Code-2" class="headerlink" title="Before Code"></a>Before Code</h3><h4 id="Create-the-symbol-table"><a href="#Create-the-symbol-table" class="headerlink" title="Create the symbol table"></a>Create the symbol table</h4><p>Symbol class</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Symbol</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> intType;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> area = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Type means the type of the symbol.</p>
<p>IntType is an integer. If it’s 0, the symbol is int. if it’s 1, the symbol is int[],  if it’s 2, the symbol is int[] []…</p>
<p>Content is its content.</p>
<p>Area is where is it.</p>
<p>I create a HashMap of Symbols, memorizing symbols created in each area.</p>
<p>When I enter a new area, area++. When I leave an area, area–, with the corresponding Symbols are destroyed. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> HashMap&lt;Integer, Symbols&gt; symbols = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> HashMap&lt;String, Function&gt; functions = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> ArrayList&lt;Error&gt; errors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> area = -<span class="number">1</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> needReturn = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> whileFlag = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>

<p><code>needReturn</code> means if the current function need to return.</p>
<p><code>whileFlag </code> means if the current code block is in while circle.</p>
<h4 id="Errors"><a href="#Errors" class="headerlink" title="Errors"></a>Errors</h4><h5 id="a"><a href="#a" class="headerlink" title="a"></a><strong>a</strong></h5><p>Just check format</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFormatIllegal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; content.length() - <span class="number">1</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">char</span> c = content.charAt(i);</span><br><span class="line">    <span class="keyword">if</span> (!isLegal(c)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (c == <span class="string">&#x27;%&#x27;</span> &amp;&amp; content.charAt(i + <span class="number">1</span>) == <span class="string">&#x27;d&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (c == <span class="string">&#x27;\\&#x27;</span> &amp;&amp; content.charAt(i + <span class="number">1</span>) != <span class="string">&#x27;n&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="b-c"><a href="#b-c" class="headerlink" title="b c"></a><strong>b c</strong></h5><p>B: Every time I get an identity, check if there is the same symbol has been defined in this area.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasSymbolInThisArea</span><span class="params">(Word word)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> symbols.get(area).hasSymbol(word);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<p>C: Check all area. If the symbol has been defined. Functions are as the same.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">hasSymbol</span><span class="params">(Word word)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (Symbols s : symbols.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (s.hasSymbol(word)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="d-e"><a href="#d-e" class="headerlink" title="d e"></a><strong>d e</strong></h5><p>To check if the function parameters are matched, I memorize parameters of every function and when I met a function call, I will scan the function call parameters and match them. I prepare a function to do this. Finally I found I need to use recursive descent again, so I add the check procedure to the recursive descent of the grammatical analyst. Please check the <code>After Code/Error d and e</code></p>
<h5 id="f-g"><a href="#f-g" class="headerlink" title="f g"></a>f g</h5><p>There is a global variety <code>needReturn</code> used to display if the current function need return. if it does but there is no return in the end of the code block, or if it doesn’t but there is return, the error will be memorized.</p>
<h5 id="h"><a href="#h" class="headerlink" title="h"></a><strong>h</strong></h5><p>Just check if it is a const. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isConst(word)) &#123;</span><br><span class="line">  error(<span class="string">&quot;h&quot;</span>, word.getLineNum());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="i-j-k"><a href="#i-j-k" class="headerlink" title="i j k"></a><strong>i j k</strong></h5><p>Capsulate function about checking missing of the symbol</p>
<p>For example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkParent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (getNextWord().typeEquals(<span class="string">&quot;RPARENT&quot;</span>)) &#123;</span><br><span class="line">        getWord();<span class="comment">// )</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        error(<span class="string">&quot;j&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="l"><a href="#l" class="headerlink" title="l"></a><strong>l</strong></h5><p>Count the number of the parameters of string and printf separately and check if they equal.</p>
<h5 id="m"><a href="#m" class="headerlink" title="m"></a><strong>m</strong></h5><p>There is a global variety <code>whileFlag</code> symbolize if the code block is in while circle. If it isn’t, any continue and break will produce error.</p>
<h3 id="After-Code-2"><a href="#After-Code-2" class="headerlink" title="After Code"></a>After Code</h3><h4 id="Area"><a href="#Area" class="headerlink" title="Area"></a>Area</h4><p>I mark the area++ when I get a block or a function, but it will lead to the situation that when enter a code block of a function, the parameters of the function can’t be memorize in the different are with the block of the function. So I changed the rules to mark area++.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">analyseBlock</span><span class="params">(<span class="keyword">boolean</span> fromFunc)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!fromFunc) &#123;</span><br><span class="line">        addArea();</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Only when the block is not from the function, the area++.</p>
<h4 id="Error-d-and-e"><a href="#Error-d-and-e" class="headerlink" title="Error d and e"></a>Error d and e</h4><p>To check if the function parameters are matched, I set an array for every function.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Function</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> String returnType;</span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;Integer&gt; paras;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>When I get a function, I memorize its return type and paras.</p>
<p>As for the <code>ArrayList&lt;Integer&gt; paras</code>, it reflects as follows:</p>
<table>
<thead>
<tr>
<th>Type</th>
<th>Example</th>
<th>Integer</th>
</tr>
</thead>
<tbody><tr>
<td>Void</td>
<td></td>
<td>-1</td>
</tr>
<tr>
<td>Int</td>
<td>a</td>
<td>0</td>
</tr>
<tr>
<td>Int[]</td>
<td>a[]</td>
<td>1</td>
</tr>
<tr>
<td>Int[] []</td>
<td>a[] [3]</td>
<td>2</td>
</tr>
</tbody></table>
<p>So when I get a function call, I will check the parameter of it with what I have memorized before.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">checkParasMatchRParas</span><span class="params">(Word ident, ArrayList&lt;Integer&gt; paras, ArrayList&lt;Integer&gt; rparas)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (paras.size() != rparas.size()) &#123;</span><br><span class="line">        error(<span class="string">&quot;d&quot;</span>, ident.getLineNum());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; paras.size(); i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!paras.get(i).equals(rparas.get(i))) &#123;</span><br><span class="line">                error(<span class="string">&quot;e&quot;</span>, ident.getLineNum());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>As for getting the parameters real type, I add the analyst procedure to the recursive descent of the grammatical analyst. Just like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">analyseExp</span><span class="params">(ArrayList&lt;Word&gt; exp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> intType = analyseAddExp(exp);</span><br><span class="line">    grammar.add(<span class="string">&quot;&lt;Exp&gt;&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> intType;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Every recursion will return an <code>intType</code>, which symbolize the final type of the expression.</p>
<p>Because the terms of one expression must be the same type, so I return only one of them.</p>
<p>This is the exit of the recursion. It will return a correct type of the expression to the top of the function.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">analyseLVal</span><span class="params">(ArrayList&lt;Word&gt; exp)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> intType = <span class="number">0</span>;</span><br><span class="line">    ...</span><br><span class="line">            <span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;LBRACK&quot;</span>)) &#123;</span><br><span class="line">                intType++;</span><br><span class="line">                ...</span><br><span class="line">            &#125;</span><br><span class="line">     ...</span><br><span class="line">    <span class="keyword">if</span> (hasSymbol(ident)) &#123;</span><br><span class="line">        <span class="keyword">return</span> getSymbol(ident).getIntType() - intType;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="代码生成"><a href="#代码生成" class="headerlink" title="代码生成"></a>代码生成</h2><p>In this part, I chose to generate Pcode.</p>
<p>I designed a type of Pcode which is an Inverse Bolan expression stack and symbol table based virtual code.</p>
<p>At the same time, I designed virtual machine to execute them.</p>
<p>The Pcode virtual machine is an imaginary machine used to run Pcode commands. It consists of: A code area (code), an instruction pointer (EIP), a stack, a var_table, a func_table and a label_table.</p>
<p>In the following passage, I will introduce how Pcode executes first and how to produce Pcode next.</p>
<h3 id="Before-Code-3"><a href="#Before-Code-3" class="headerlink" title="Before Code"></a>Before Code</h3><h4 id="How-does-the-virtual-machine-run"><a href="#How-does-the-virtual-machine-run" class="headerlink" title="How does the virtual machine run"></a>How does the virtual machine run</h4><p>First, we need a <code>codes</code> list and a <code>stack</code>(int).</p>
<p>An <code>eip</code>: presents the address of current running code.</p>
<p>A <code>varTable</code>: memorizes the address of the variety in stack.</p>
<p>A <code>funcTable</code>: memorizes the address of the function in codes list.</p>
<p>A <code>labelTable</code>: Memorizes the address of the label in codes list.</p>
<p>Then, run the code one after another and manage the stack.</p>
<h4 id="How-to-distinguish-different-variety"><a href="#How-to-distinguish-different-variety" class="headerlink" title="How to distinguish different variety"></a>How to distinguish different variety</h4><p>Before generate codes, differentiate varieties from different scopes by its only scope number, like: <code>areaID + &quot;_&quot; + curWord.getContent()</code>. In this situation, the variety will not appear more than once in codes, except for recursive function call, which will be solved by push <code>varTable</code> to stack(show later).</p>
<h4 id="Specific-Code-Definition"><a href="#Specific-Code-Definition" class="headerlink" title="Specific Code Definition"></a>Specific Code Definition</h4><p>First, define a class for PCode:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PCode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> CodeType type;</span><br><span class="line">    <span class="keyword">private</span> Object value1 = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> Object value2 = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>It presents one code object, which has a CodeType and two operating values. CodeType is an enum. Value1 and value2 maybe Integer or String or null, which depends on specific code type.</p>
<h5 id="Calculation-Type"><a href="#Calculation-Type" class="headerlink" title="Calculation Type"></a>Calculation Type</h5><p>Two operators:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> b = pop();</span><br><span class="line"><span class="keyword">int</span> a = pop();</span><br><span class="line">push(cal(a,b));</span><br></pre></td></tr></table></figure>

<p>Single operator:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">push(cal(pop()));</span><br></pre></td></tr></table></figure>

<h5 id="VAR"><a href="#VAR" class="headerlink" title="VAR"></a>VAR</h5><p><strong>VAR</strong> command to declare a variable, save the variable name and the address assigned to it in the variable table.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> VAR: &#123;</span><br><span class="line">    Var <span class="keyword">var</span> = <span class="keyword">new</span> Var(stack.size());</span><br><span class="line">    varTable.put((String) code.getValue1(), <span class="keyword">var</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Var.class:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Var</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> index;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> dimension = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> dim1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> dim2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="DIMVAR"><a href="#DIMVAR" class="headerlink" title="DIMVAR"></a>DIMVAR</h5><p><strong>DIMVAR</strong> command to declare an array. Set the dimension information of the var.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> DIMVAR: &#123;</span><br><span class="line">    Var <span class="keyword">var</span> = getVar((String) code.getValue1());</span><br><span class="line">    <span class="keyword">int</span> n = (<span class="keyword">int</span>) code.getValue2();</span><br><span class="line">    <span class="keyword">var</span>.setDimension(n);</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> i = pop();</span><br><span class="line">        <span class="keyword">var</span>.setDim1(i);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> j = pop(), i = pop();</span><br><span class="line">        <span class="keyword">var</span>.setDim1(i);</span><br><span class="line">        <span class="keyword">var</span>.setDim2(j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="PLACEHOLDER"><a href="#PLACEHOLDER" class="headerlink" title="PLACEHOLDER"></a>PLACEHOLDER</h5><p><strong>PLACEHOLDER</strong> command to grow the stack down, allocate the new space to the variety and array.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> PLACEHOLDER: &#123;</span><br><span class="line">    Var <span class="keyword">var</span> = getVar((String) code.getValue1());</span><br><span class="line">    <span class="keyword">int</span> n = (<span class="keyword">int</span>) code.getValue2();</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        push(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">var</span>.getDim1(); i++) &#123;</span><br><span class="line">            push(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="keyword">var</span>.getDim1() * <span class="keyword">var</span>.getDim2(); i++) &#123;</span><br><span class="line">            push(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h5><p>Calculation type: pop the stack top once or twice, calculate them and push again.</p>
<p>Jump Type: When it’s command about jump, just check if the condition is satisfied and change the <code>eip</code>.</p>
<p>Function call: as follows</p>
<h4 id="Function-call-procedure"><a href="#Function-call-procedure" class="headerlink" title="Function call procedure"></a>Function call procedure</h4><p>First, before function call, there will be some parameters to be pushed into the stack. Each will be followed by a <code>RPARA</code> command, which memorize the address of the previous variety. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> RPARA: &#123;</span><br><span class="line">    <span class="keyword">int</span> n = (<span class="keyword">int</span>) code.getValue1();</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        rparas.add(stack.size() - <span class="number">1</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        rparas.add(stack.get(stack.size() - <span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Second, function <code>CALL</code>.</p>
<p>Memorize the eip, stack top address, and information about the function(In fact, they will be pushed into stack too). Then update the <code>varTable</code> and <code>eip</code>.  Ready for execute function. </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> CALL: &#123;</span><br><span class="line">    Func func = funcTable.get((String) code.getValue1());</span><br><span class="line">    retInfos.add(<span class="keyword">new</span> RetInfo(eip, varTable, stack.size() - <span class="number">1</span>, func.getArgs(), func.getArgs(), nowArgsNum));</span><br><span class="line">    eip = func.getIndex();</span><br><span class="line">    varTable = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    callArgsNum = func.getArgs();</span><br><span class="line">    nowArgsNum = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Finally, return when it’s <code>RET</code></p>
<p>Restore <code>eip</code>, <code>varTable</code> from <code>RetInfo</code>, clear the new information pushed when function in the stack.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> RET: &#123;</span><br><span class="line">    <span class="keyword">int</span> n = (<span class="keyword">int</span>) code.getValue1();</span><br><span class="line">    RetInfo info = retInfos.remove(retInfos.size() - <span class="number">1</span>);</span><br><span class="line">    eip = info.getEip();</span><br><span class="line">    varTable = info.getVarTable();</span><br><span class="line">    callArgsNum = info.getCallArgsNum();</span><br><span class="line">    nowArgsNum = info.getNowArgsNum();</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">        stack.subList(info.getStackPtr() + <span class="number">1</span> - info.getParaNum(), stack.size() - <span class="number">1</span>).clear();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        stack.subList(info.getStackPtr() + <span class="number">1</span> - info.getParaNum(), stack.size()).clear();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Value-or-Address"><a href="#Value-or-Address" class="headerlink" title="Value or Address"></a>Value or Address</h4><p>Push value or address of the variety is an important thing, it depends on what I need, which will be presented when I describe how to generate codes.</p>
<p>The command action is as follows(<code>getAddress</code> is used for get the address of the previous variety ).</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> VALUE: &#123;</span><br><span class="line">    Var <span class="keyword">var</span> = getVar((String) code.getValue1());</span><br><span class="line">    <span class="keyword">int</span> n = (<span class="keyword">int</span>) code.getValue2();</span><br><span class="line">    <span class="keyword">int</span> address = getAddress(<span class="keyword">var</span>, n);</span><br><span class="line">    push(stack.get(address));</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">case</span> ADDRESS: &#123;</span><br><span class="line">    Var <span class="keyword">var</span> = getVar((String) code.getValue1());</span><br><span class="line">    <span class="keyword">int</span> n = (<span class="keyword">int</span>) code.getValue2();</span><br><span class="line">    <span class="keyword">int</span> address = getAddress(<span class="keyword">var</span>, n);</span><br><span class="line">    push(address);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Code-Generate"><a href="#Code-Generate" class="headerlink" title="Code Generate"></a>Code Generate</h4><p>Code generated from the grammatical analyst procedure.</p>
<h5 id="Declaration"><a href="#Declaration" class="headerlink" title="Declaration"></a>Declaration</h5><p>There is no need to distinguish const and var. When declare a variety, just new a variety and let it point to the stack top. Then if it has an initialization, just push the values one after another. If not, add a <code>PLACEHOLDER</code> command to push something(I push 0) to the stack to hold the place.</p>
<h5 id="Assign-sentence"><a href="#Assign-sentence" class="headerlink" title="Assign sentence"></a>Assign sentence</h5><p>In this situation, first calculate and push the address of the variety to the stack top. Then analyze expressions. After that, there are only two number in the stack, which are address and value. Assign the value to the address.</p>
<h5 id="Condition-control-sentence"><a href="#Condition-control-sentence" class="headerlink" title="Condition control sentence"></a>Condition control sentence</h5><p>First, generate labels. Then, place jump sentences in the proper places.</p>
<p>labels about if and while will be generated and then stored in a stack type structure. like:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">whileLabels.add(<span class="keyword">new</span> HashMap&lt;&gt;());</span><br><span class="line">whileLabels.get(whileLabels.size() - <span class="number">1</span>).put(<span class="string">&quot;while&quot;</span>, labelGenerator.getLabel(<span class="string">&quot;while&quot;</span>));</span><br><span class="line">whileLabels.get(whileLabels.size() - <span class="number">1</span>).put(<span class="string">&quot;while_end&quot;</span>, labelGenerator.getLabel(<span class="string">&quot;while_end&quot;</span>));</span><br><span class="line">whileLabels.get(whileLabels.size() - <span class="number">1</span>).put(<span class="string">&quot;while_block&quot;</span>, labelGenerator.getLabel(<span class="string">&quot;while_block&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>Take if as example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;IFTK&quot;</span>)) &#123;</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.LABEL, ifLabels.get(ifLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;if&quot;</span>)));</span><br><span class="line">    ...</span><br><span class="line">    analyseCond(<span class="string">&quot;IFTK&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.JZ, ifLabels.get(ifLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;else&quot;</span>)));</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.LABEL, ifLabels.get(ifLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;if_block&quot;</span>)));</span><br><span class="line">    analyseStmt();</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.JMP, ifLabels.get(ifLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;if_end&quot;</span>)));</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.LABEL, ifLabels.get(ifLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;else&quot;</span>)));</span><br><span class="line">    <span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;ELSETK&quot;</span>)) &#123;</span><br><span class="line">        getWord(); <span class="comment">//else</span></span><br><span class="line">        analyseStmt();</span><br><span class="line">    &#125;</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.LABEL, ifLabels.get(ifLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;if_end&quot;</span>)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>while:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;WHILETK&quot;</span>)) &#123;</span><br><span class="line">    ...</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.LABEL, whileLabels.get(whileLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;while&quot;</span>)));</span><br><span class="line">    ...</span><br><span class="line">    analyseCond(<span class="string">&quot;WHILETK&quot;</span>);</span><br><span class="line">    ...</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.JZ, whileLabels.get(whileLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;while_end&quot;</span>)));</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.LABEL, whileLabels.get(whileLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;while_block&quot;</span>)));</span><br><span class="line">    analyseStmt();</span><br><span class="line">    ...</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.JMP, whileLabels.get(whileLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;while&quot;</span>)));</span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.LABEL, whileLabels.get(whileLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;while_end&quot;</span>)));</span><br><span class="line">    whileLabels.remove(whileLabels.size() - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// break</span></span><br><span class="line"><span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;BREAKTK&quot;</span>)) &#123;</span><br><span class="line">    getWord();<span class="comment">//break</span></span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.JMP, whileLabels.get(whileLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;while_end&quot;</span>)));</span><br><span class="line"> 		...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// continue</span></span><br><span class="line"><span class="keyword">if</span> (word.typeEquals(<span class="string">&quot;CONTINUETK&quot;</span>)) &#123;</span><br><span class="line">    getWord();<span class="comment">//continue</span></span><br><span class="line">    codes.add(<span class="keyword">new</span> PCode(CodeType.JMP, whileLabels.get(whileLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;while&quot;</span>)));</span><br><span class="line">    ...</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<h3 id="After-Code-3"><a href="#After-Code-3" class="headerlink" title="After Code"></a>After Code</h3><p>Because of some runtime errors and information shortages, I added and removed some Pcode. At the same, there are some new troubles about address pass and short circuit calculation.</p>
<h4 id="Specific-Code-Definition-1"><a href="#Specific-Code-Definition-1" class="headerlink" title="Specific Code Definition"></a>Specific Code Definition</h4><p>In Operation, <code>push()</code> means put value into the top of the stack. <code>pop()</code> means pop the value from the top of the stack.</p>
<h5 id="Common-Type"><a href="#Common-Type" class="headerlink" title="Common Type"></a>Common Type</h5><table>
<thead>
<tr>
<th>CodeType</th>
<th>Value1</th>
<th>Value2</th>
<th>Operation</th>
</tr>
</thead>
<tbody><tr>
<td>LABEL</td>
<td>Label_name</td>
<td>Set  a label</td>
<td></td>
</tr>
<tr>
<td>VAR</td>
<td>Ident_name</td>
<td>Declare  a variety</td>
<td></td>
</tr>
<tr>
<td>PUSH</td>
<td>Ident_name/Digit</td>
<td>push(value1)</td>
<td></td>
</tr>
<tr>
<td>POP</td>
<td>Address</td>
<td>Ident_name</td>
<td>*value1 = value2</td>
</tr>
<tr>
<td>JZ</td>
<td>Label_name</td>
<td></td>
<td>Jump if stack top is zero</td>
</tr>
<tr>
<td>JNZ</td>
<td>Label_name</td>
<td></td>
<td>Jump if stack top is not zero</td>
</tr>
<tr>
<td>JMP</td>
<td>Label_name</td>
<td></td>
<td>Jump unconditionally</td>
</tr>
<tr>
<td>MAIN</td>
<td></td>
<td></td>
<td>Main function label</td>
</tr>
<tr>
<td>FUNC</td>
<td></td>
<td></td>
<td>Function label</td>
</tr>
<tr>
<td>ENDFUNC</td>
<td></td>
<td></td>
<td>End of function label</td>
</tr>
<tr>
<td>PARA</td>
<td>Ident_name</td>
<td>Type</td>
<td>Parameters</td>
</tr>
<tr>
<td>RET</td>
<td>Return value or not</td>
<td></td>
<td>Function return</td>
</tr>
<tr>
<td>CALL</td>
<td>Function name</td>
<td></td>
<td>Function call</td>
</tr>
<tr>
<td>RPARA</td>
<td>Type</td>
<td></td>
<td>Get parameters ready for function call</td>
</tr>
<tr>
<td>GETINT</td>
<td></td>
<td></td>
<td>Get a integer and put it into stack top</td>
</tr>
<tr>
<td>PRINT</td>
<td>String</td>
<td>Para num</td>
<td>Pop values and print.</td>
</tr>
<tr>
<td>DIMVAR</td>
<td>Ident_name</td>
<td>Type</td>
<td>Set dimension info for array variety</td>
</tr>
<tr>
<td>VALUE</td>
<td>Ident_name</td>
<td>Type</td>
<td>Get the variety value</td>
</tr>
<tr>
<td>ADDRESS</td>
<td>Ident_name</td>
<td>Type</td>
<td>Get the variety address</td>
</tr>
<tr>
<td>PLACEHOLDER</td>
<td></td>
<td></td>
<td>Push something to hold places</td>
</tr>
<tr>
<td>EXIT</td>
<td></td>
<td></td>
<td>Exit</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th>CodeType</th>
<th>Value1</th>
<th>Value2</th>
<th>Operation</th>
</tr>
</thead>
<tbody><tr>
<td>ADD</td>
<td></td>
<td></td>
<td>+</td>
</tr>
<tr>
<td>SUB</td>
<td></td>
<td></td>
<td>-</td>
</tr>
<tr>
<td>MUL</td>
<td></td>
<td></td>
<td>*</td>
</tr>
<tr>
<td>DIV</td>
<td></td>
<td></td>
<td>/</td>
</tr>
<tr>
<td>MOD</td>
<td></td>
<td></td>
<td>%</td>
</tr>
<tr>
<td>CMPEQ</td>
<td></td>
<td></td>
<td>==</td>
</tr>
<tr>
<td>CMPNE</td>
<td></td>
<td></td>
<td>!=</td>
</tr>
<tr>
<td>CMPGT</td>
<td></td>
<td></td>
<td>&gt;</td>
</tr>
<tr>
<td>CMPLT</td>
<td></td>
<td></td>
<td>&lt;</td>
</tr>
<tr>
<td>CMPGE</td>
<td></td>
<td></td>
<td>&gt;=</td>
</tr>
<tr>
<td>CMPLE</td>
<td></td>
<td></td>
<td>&lt;=</td>
</tr>
<tr>
<td>AND</td>
<td></td>
<td></td>
<td>&amp;&amp;</td>
</tr>
<tr>
<td>OR</td>
<td></td>
<td></td>
<td>||</td>
</tr>
<tr>
<td>NOT</td>
<td></td>
<td></td>
<td>!</td>
</tr>
<tr>
<td>NEG</td>
<td></td>
<td></td>
<td>-</td>
</tr>
<tr>
<td>POS</td>
<td></td>
<td></td>
<td>+</td>
</tr>
</tbody></table>
<h4 id="short-circuit-calculation"><a href="#short-circuit-calculation" class="headerlink" title="short circuit calculation"></a>short circuit calculation</h4><p>There are two situations I need to use short circuit calculation :</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span> <span class="keyword">if</span>(a&amp;&amp;b) <span class="comment">// a is false</span></span><br><span class="line"><span class="number">2.</span> <span class="keyword">if</span>(a||b) <span class="comment">// b is true</span></span><br></pre></td></tr></table></figure>

<p>This seems not an easy thing and I acutally spent lots of time to solve it.</p>
<p>My method is as follows:</p>
<p>First, when I analyze <code>analyseLOrExp</code>, every <code>analyseLAndExp</code> will be followed by a <code>JNZ</code>, which is used for detect if the cond is false. If it is, jump to the if body label. At the same time, I generated cond label, which is ready for the <code>analyseLAndExp</code>.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">analyseLOrExp</span><span class="params">(ArrayList&lt;Word&gt; exp, String from)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (...) &#123;</span><br><span class="line">        ...</span><br><span class="line">        String label = labelGenerator.getLabel(<span class="string">&quot;cond_&quot;</span> + i);</span><br><span class="line">        analyseLAndExp(exp1, from, label);</span><br><span class="line">        codes.add(<span class="keyword">new</span> PCode(CodeType.LABEL, label));</span><br><span class="line">        <span class="keyword">if</span> (...) &#123;</span><br><span class="line">            codes.add(<span class="keyword">new</span> PCode(CodeType.OR));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (...) &#123;</span><br><span class="line">            <span class="keyword">if</span> (...) &#123;</span><br><span class="line">                codes.add(<span class="keyword">new</span> PCode(CodeType.JNZ, ifLabels.get(ifLabels.size() - <span class="number">1</span>).get(<span class="string">&quot;if_block&quot;</span>)));</span><br><span class="line">            &#125;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In the <code>analyseLAndExp</code>, every <code>analyseEqExp</code> will be followed by a <code>JZ</code>, which is used for detect if the cond is true. If it is, jump to the cond label I set just now.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">analyseLAndExp</span><span class="params">(ArrayList&lt;Word&gt; exp, String from, String label)</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">for</span> (...) &#123;</span><br><span class="line">        ...</span><br><span class="line">        analyseEqExp(exp1);</span><br><span class="line">        <span class="keyword">if</span> (...) &#123;</span><br><span class="line">            codes.add(<span class="keyword">new</span> PCode(CodeType.AND));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (...) &#123;</span><br><span class="line">            <span class="keyword">if</span> (...) &#123;</span><br><span class="line">                codes.add(<span class="keyword">new</span> PCode(CodeType.JZ, label));</span><br><span class="line">            &#125; </span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>By these means, short circuit calculation is solved.</p>
<h2 id="总结感想"><a href="#总结感想" class="headerlink" title="总结感想"></a>总结感想</h2><p>[[编译实验总结感想]]</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/posts/11219/"><img class="fill" src="https://tva1.sinaimg.cn/large/008i3skNly1gwkz3r6pstj30sg0lc43b.jpg" alt="2021年11月的第一场雪"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-11-06T18:04:08.000Z" title="2021/11/7 上午2:04:08">2021-11-07</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.653Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">a few seconds read (About 27 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/11219/">2021年11月的第一场雪</a></h1><div class="content"><iframe allow="autoplay *; encrypted-media *; fullscreen *" frameborder="0" height="150" style="width:100%;max-width:660px;overflow:hidden;background:transparent;" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" src="https://embed.music.apple.com/cn/album/the-four-seasons-concerto-no-4-in-f-minor-rv-297/883897569?i=883897598&l=en"></iframe>

<p>真的很冷</p>
<p>今天大家的关注点都在S赛，我也未能免俗参与其中</p>
</div></article></div><div class="card"><div class="card-image"><a class="image is-7by3" href="/posts/53100/"><img class="fill" src="https://tva1.sinaimg.cn/large/008i3skNly1gwv08ty64aj31340m4761.jpg" alt="Memo"></a></div><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-10-28T09:29:00.000Z" title="2021/10/28 下午5:29:00">2021-10-28</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.662Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">9 minutes read (About 1378 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/53100/">Memo</a></h1><div class="content"><h1 id="Memo"><a href="#Memo" class="headerlink" title="Memo"></a>Memo</h1><p>Memo用于随时记录，记录生活中的某一刻，记录今天的心情，或是记录看过的一部电影，一本书，留下自己此时的感想，并在自己最爱的电影或书籍的二刷三刷后再次记录下时间和新的想法…</p>
<p>灵感来源于豆瓣，比起豆瓣的功能多出的个人需求为：需要一个简洁没有过量冗余信息的片单和书单记录软件，记录二刷，三刷的时间，以及想要随时记录每一天，并且在几年后回顾那年今日，留一些感动与感慨，让每一天都值得被纪念，故开发此软件。</p>
<h2 id="图片"><a href="#图片" class="headerlink" title="图片"></a>图片</h2><p><img src="README/image-20211120173053786.png"></p>
<p>（介绍及短评摘自豆瓣，侵删）</p>
<p><img src="README/008i3skNly1gwlr5i3osjj30u010ujtt.jpg"></p>
<p>Mac, iPad适配</p>
<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><h3 id="主页面"><a href="#主页面" class="headerlink" title="主页面"></a>主页面</h3><p>主界面分为3个标签：主页，电影，书籍</p>
<h5 id="主页"><a href="#主页" class="headerlink" title="主页"></a>主页</h5><p><img src="README/008i3skNly1gwlqj9g2ltj30pi0tkq5a.jpg"></p>
<p><img src="README/008i3skNly1gwlqj9pbc4j30pk0vowg3.jpg"></p>
<h5 id="电影"><a href="#电影" class="headerlink" title="电影"></a>电影</h5><p>这里是你看过的电影片单，你可以随时看到你标记过的所有电影，以及在任何时候添加一个新的电影进入你的片单</p>
<p>进入某条电影，如果你输入的电影在数据库之中（数据来自豆瓣，侵删），你就可以看到关于电影的介绍：演员，导演，豆瓣评分，类别，介绍等，以及最重要的，在最下方，看到你第一次观看的时间以及感想</p>
<p>当然，点击此方框，你可以进入到第二次标记的页面，记录下你的第二次观影以及新的感想</p>
<p><img src="README/008i3skNly1gwlr3yyccmj30u00yfdi5.jpg"></p>
<p><img src="README/008i3skNly1gwuznrfz7oj30u00xmju5.jpg"></p>
<h5 id="书籍"><a href="#书籍" class="headerlink" title="书籍"></a>书籍</h5><p>类似电影，这里是你的书单，你可以添加你看过的书籍，并且记录第n次阅读的体验，相信每一次阅读，都会发现不少新东西</p>
<p><img src="README/008i3skNly1gwlr1ixi5pj30u010gmys.jpg"></p>
<h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><ul>
<li>标记某一天的感受</li>
<li>标记某本电影，某本书</li>
<li>多次标记某电影和书的观看时间和感受</li>
<li>自动展示电影和书籍的相关图片与简介</li>
<li>图文并茂的主页卡片展示设计</li>
<li>在主页展示进一个月看过的电影</li>
<li>在主页展示今天以及那年今日的感想</li>
</ul>
<h2 id="架构以及实现"><a href="#架构以及实现" class="headerlink" title="架构以及实现"></a>架构以及实现</h2><p>源代码文件共25个</p>
<p>主要分为三个部分：Controller Model Views</p>
<p><img src="README/008i3skNly1gwuz8sdizwj306r0kx3z9.jpg" alt="image-20211027232454144"></p>
<h4 id="Controller"><a href="#Controller" class="headerlink" title="Controller"></a>Controller</h4><p>一些静态函数，实现点击界面按钮后的某些后端反应以及后端用到的函数，如图像获取，日期格式化，Mark筛选等</p>
<p>其中图片的读取使用了异步加载url的方式，如果url没有解析成功将不会显示图片</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ImageLoader</span>: <span class="title">ObservableObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> didChange <span class="operator">=</span> <span class="type">PassthroughSubject</span>&lt;<span class="type">Data</span>, <span class="type">Never</span>&gt;()</span><br><span class="line">    <span class="keyword">var</span> data <span class="operator">=</span> <span class="type">Data</span>() &#123;</span><br><span class="line">        <span class="keyword">didSet</span> &#123;</span><br><span class="line">            didChange.send(data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">init</span>(<span class="params">urlString</span>: <span class="type">String</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">guard</span> <span class="keyword">let</span> url <span class="operator">=</span> <span class="type">URL</span>(string: urlString) <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">let</span> task <span class="operator">=</span> <span class="type">URLSession</span>.shared.dataTask(with: url) &#123; (data, response, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> data <span class="operator">=</span> data <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">                <span class="keyword">self</span>.data <span class="operator">=</span> data</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        task.resume()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Model"><a href="#Model" class="headerlink" title="Model"></a>Model</h4><p>主要用到的对象为Mark：</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mark</span>: <span class="title">Codable</span>, <span class="title">Identifiable</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> index:<span class="type">Int</span> <span class="operator">=</span> <span class="number">0</span></span><br><span class="line">    <span class="keyword">var</span> type:<span class="type">ModelType</span> <span class="operator">=</span> <span class="type">ModelType</span>.<span class="type">NONE</span></span><br><span class="line">    <span class="keyword">var</span> name <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">var</span> dates: [<span class="type">Date</span>] <span class="operator">=</span> []</span><br><span class="line">    <span class="keyword">var</span> feeling <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">init</span>(<span class="params">index</span>: <span class="type">Int</span>,<span class="params">type</span>:<span class="type">ModelType</span>, <span class="params">name</span>:<span class="type">String</span>, <span class="params">date</span>:<span class="type">Date</span>, <span class="params">feeling</span>:<span class="type">String</span>)</span>&#123;</span><br><span class="line">        <span class="keyword">self</span>.index <span class="operator">=</span> index</span><br><span class="line">        <span class="keyword">self</span>.type <span class="operator">=</span> type</span><br><span class="line">        <span class="keyword">self</span>.name <span class="operator">=</span> name</span><br><span class="line">        <span class="keyword">self</span>.dates.append(date)</span><br><span class="line">        <span class="keyword">self</span>.feeling <span class="operator">=</span> feeling</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Movie, Book 为电影和书籍的简介，不进行重复的展示</p>
<p>他们遵循MarkableObject协议，用于在展示Mark详情时读取object后再作类型判断</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Movie</span>: <span class="title">Hashable</span>, <span class="title">Codable</span>, <span class="title">Identifiable</span>, <span class="title">MarkableObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> id: <span class="type">String</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span></span><br><span class="line">		<span class="operator">...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ModelData负责数据存储的任务</p>
<p>用到了自带的UserDefaults.standard存储数据</p>
<p>movies和books分别为电影和书籍数据集，内置在app中</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelData</span>: <span class="title">ObservableObject</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> moviesDict <span class="operator">=</span> getMoviesDict(movies: load(<span class="string">&quot;movies.json&quot;</span>))</span><br><span class="line">    <span class="keyword">var</span> booksDict <span class="operator">=</span> getBooksDict(books: load(<span class="string">&quot;books.json&quot;</span>))</span><br><span class="line">    <span class="meta">@Published</span> <span class="keyword">var</span> marks: [<span class="type">Mark</span>] <span class="operator">=</span> []</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">init</span>()</span> &#123;</span><br><span class="line">        loadMarks()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">loadMarks</span>()</span> &#123;</span><br><span class="line">        marks <span class="operator">=</span> <span class="type">UserDefaults</span>.standard.object(([<span class="type">Mark</span>]).<span class="keyword">self</span>, with: <span class="string">&quot;Marks&quot;</span>) <span class="operator">??</span> []</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">saveMarks</span>()</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> standard <span class="operator">=</span> <span class="type">UserDefaults</span>.standard</span><br><span class="line">        standard.set(object: marks, forKey: <span class="string">&quot;Marks&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ModelType为枚举类型，用于Mark类型判断</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ModelType</span>: <span class="title">String</span>, <span class="title">Codable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">NONE</span> <span class="operator">=</span> <span class="string">&quot;无&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">MOVIE</span> <span class="operator">=</span> <span class="string">&quot;电影&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">BOOK</span> <span class="operator">=</span> <span class="string">&quot;书籍&quot;</span></span><br><span class="line">    <span class="keyword">case</span> <span class="type">DAY</span> <span class="operator">=</span> <span class="string">&quot;今天&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Views"><a href="#Views" class="headerlink" title="Views"></a>Views</h4><p>界面UI</p>
<p>用到了environmentObject来同步各个界面的数据</p>
<p>父界面给子界面传递@Binding的变量，子界面拿到引用直接演示和修改，不会出现数据不同步的问题</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@main</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MemoApp</span>: <span class="title">App</span> </span>&#123;</span><br><span class="line">    <span class="meta">@StateObject</span> <span class="keyword">private</span> <span class="keyword">var</span> modelData <span class="operator">=</span> <span class="type">ModelData</span>()</span><br><span class="line">    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">Scene</span> &#123;</span><br><span class="line">        <span class="type">WindowGroup</span> &#123;</span><br><span class="line">            <span class="type">ContentView</span>()</span><br><span class="line">                    .environmentObject(modelData)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="MainMenu"><a href="#MainMenu" class="headerlink" title="MainMenu"></a>MainMenu</h5><p>MarkList: Mark列表，即展示电影和书籍列表</p>
<p>使用NavigationLink，向子界面：MarkDetail传递mark的引用</p>
<p><img src="README/image-20211027234131178.png" alt="image-20211027234131178"></p>
<p>HomeView: 主界面</p>
<h5 id="Mark"><a href="#Mark" class="headerlink" title="Mark"></a>Mark</h5><p>关于Mark的界面</p>
<p>MarkDetail: 一个Mark的详情</p>
<p>大部分子界面都如此UI一样，引入modelData的环境变量，承接上一级传下来的@Binding变量，实现数据的同步</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnvironmentObject</span> <span class="keyword">var</span> modelData: <span class="type">ModelData</span></span><br><span class="line"><span class="meta">@Binding</span> <span class="keyword">var</span> mark: <span class="type">Mark</span></span><br></pre></td></tr></table></figure>

<p>其中要进行object的解析，如果用户输入能索引本地数据集的一个条目上，将会展示此object的详情</p>
<p><img src="README/image-20211027234003022.png" alt="image-20211027234003022"></p>
<p>MarkAdd: Mark增加界面</p>
<p>MarkEdit: Mark修改界面</p>
<p>MarkToday: 标记今天界面</p>
<p>这三个UI都用到了@State来实时同步Form表单中的信息</p>
<p>以至于用户输入能够及时的反应在变量上并且写入modelData</p>
<p><img src="README/image-20211027234224510.png" alt="image-20211027234224510"></p>
<h4 id="Kit"><a href="#Kit" class="headerlink" title="Kit"></a>Kit</h4><p>其他组件</p>
<p><img src="README/image-20211027234350311.png" alt="image-20211027234350311"></p>
<p>电影和书籍详情，时间线，圆形和方形图片，卡片组件等</p>
<p>均已展示在各个页面中</p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-06-26T03:23:00.000Z" title="2021/6/26 上午11:23:00">2021-06-26</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.650Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">10 minutes read (About 1505 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/8987/">BUAAOO-第四单元总结</a></h1><div class="content"><h1 id="BUAAOO-第四单元总结"><a href="#BUAAOO-第四单元总结" class="headerlink" title="BUAAOO-第四单元总结"></a>BUAAOO-第四单元总结</h1><h3 id="总结本单元作业的架构设计"><a href="#总结本单元作业的架构设计" class="headerlink" title="总结本单元作业的架构设计"></a>总结本单元作业的架构设计</h3><p>本单元任务为设计UML分析器，包括类图，顺序图，状态图</p>
<h4 id="第一次作业"><a href="#第一次作业" class="headerlink" title="第一次作业"></a>第一次作业</h4><p>实现类图分析</p>
<p>将UML元素根据其含义分为如下层次结构</p>
<p>部分元素根据需求分装为MyXXX</p>
<p><img src="BUAAOO-%E7%AC%AC%E5%9B%9B%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210626103351737.png"></p>
<p>根据逻辑层次，读入过程分为三个循环，分别处理三个层次的元素</p>
<table>
<thead>
<tr>
<th>循环轮次</th>
<th>处理元素</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>UmlClass UmlInterface UmlAssociationEnd</td>
</tr>
<tr>
<td>2</td>
<td>UmlOperation UmlAttribute UmlAssociation UmlGeneralization UmlInterfaceRealization</td>
</tr>
<tr>
<td>3</td>
<td>UmlParameter</td>
</tr>
</tbody></table>
<h4 id="第二次作业"><a href="#第二次作业" class="headerlink" title="第二次作业"></a>第二次作业</h4><p>实现顺序图，状态图</p>
<p>将UML元素根据其含义分为如下层次结构</p>
<p>部分元素根据需求分装为MyXXX</p>
<p><img src="BUAAOO-%E7%AC%AC%E5%9B%9B%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210626103946632.png"></p>
<p>根据逻辑层次，读入过程分为四个循环，分别处理四个层次的元素</p>
<table>
<thead>
<tr>
<th>循环轮次</th>
<th>处理元素</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>UmlClass UmlInterface UmlAssociationEnd UmlInteraction UmlStateMachine UmlRegion</td>
</tr>
<tr>
<td>2</td>
<td>UmlOperation UmlAttribute UmlAssociation UmlGeneralization UmlInterfaceRealization UmlLifeline UmlState UmlPseudostate UmlFinalState</td>
</tr>
<tr>
<td>3</td>
<td>UmlParameter UmlMessage UmlTransition</td>
</tr>
<tr>
<td>4</td>
<td>UmlEvent</td>
</tr>
</tbody></table>
<h4 id="第三次作业"><a href="#第三次作业" class="headerlink" title="第三次作业"></a>第三次作业</h4><p>架构同第二次。</p>
<p>其他的就是一些图算法的问题了。</p>
<h3 id="总结自己在四个单元中架构设计及OO方法理解的演进"><a href="#总结自己在四个单元中架构设计及OO方法理解的演进" class="headerlink" title="总结自己在四个单元中架构设计及OO方法理解的演进"></a>总结自己在四个单元中架构设计及OO方法理解的演进</h3><table>
<thead>
<tr>
<th>单元</th>
<th>理解</th>
</tr>
</thead>
<tbody><tr>
<td>第一单元</td>
<td>面向对象的层次化设计：factor，term，poly层次结构逻辑分明，各司其职，同时又都实现某接口，递归下降的操作过程中非常符合人的直觉感受。认识到清晰的逻辑架构的重要性。</td>
</tr>
<tr>
<td>第二单元</td>
<td>多线程设计：多线程的加入使得程序有了更多的不确定性。线程之间的交互在逻辑需要深入理解，UML流程图的作用。</td>
</tr>
<tr>
<td>第三单元</td>
<td>基于JML的设计：学到了JML规格相关知识，工程化思想进一步提升</td>
</tr>
<tr>
<td>第四单元</td>
<td>UML：清晰且彻底的理解了面向对象层次化设计的形态和结构</td>
</tr>
</tbody></table>
<h3 id="总结自己在四个单元中测试理解与实践的演进"><a href="#总结自己在四个单元中测试理解与实践的演进" class="headerlink" title="总结自己在四个单元中测试理解与实践的演进"></a>总结自己在四个单元中测试理解与实践的演进</h3><table>
<thead>
<tr>
<th>单元</th>
<th>理解 实践</th>
</tr>
</thead>
<tbody><tr>
<td>第一单元</td>
<td>利用python生存复杂数据，边界数据进行测试</td>
</tr>
<tr>
<td>第二单元</td>
<td>需要考虑线程之间时间差异可能带来的问题，性能方面也要注意特殊情况，形式化验证</td>
</tr>
<tr>
<td>第三单元</td>
<td>没怎么测，错了一片，看来测试很重要</td>
</tr>
<tr>
<td>第四单元</td>
<td>利用工具，手动构造较为复杂的UML图，进行测试。</td>
</tr>
</tbody></table>
<h3 id="总结自己的课程收获"><a href="#总结自己的课程收获" class="headerlink" title="总结自己的课程收获"></a>总结自己的课程收获</h3><p>​    16周连续的任务（其中一周有休息）任务量确实比较大，回首自己的前三篇博客，也能看到自己泡一天图书馆写程序的影子，为BUG抓狂的夜晚，周三看结果看到“你在强测中得到0分”的悲痛心情。</p>
<p>​    每周精确到天的任务，不得不说，这是一门硬课。但重要的是确实看到了自己的在这门课上的收获有多大。这是一门实实在在能学到很多东西的课程，无论是代码风格，程序基础，性能算法，还是最重要的架构设计，我都得到了比较大的提升，在最重要的架构设计上，我深刻理解了对于复杂程序甚至是工程程序中，无论是对个人还是团队合作，面向对象思想的重要性。</p>
<p>​    前几周投入的精力更大一些，第一单元和第二单元收获颇丰，得分也比较好看，第三单元有所松懈，有幸得到了强测0分体验。这门课没有考试，却比考试周突击的课能学到更多东西。</p>
<p>​    虽然最后作为社恐和菜鸡没有在研讨课发过言，也没得到什么奖，或许最后得分比较一般，但是这门课确实是我在计算机学院到目前为止感觉上的最舒服的一门课，没有什么遗憾了。</p>
<p>​    非常感谢可爱的吴际老师一学期的辛勤教学，lyj学长前两单元架构经验的倾情分享和研讨课课程组织，还有其他助教们全程的辛勤付出！</p>
<h3 id="立足于自己的体会给课程提三个具体改进建议"><a href="#立足于自己的体会给课程提三个具体改进建议" class="headerlink" title="立足于自己的体会给课程提三个具体改进建议"></a>立足于自己的体会给课程提三个具体改进建议</h3><ol>
<li>建议第三单元第四单元互换时间，第三单元内容简单，适合考期时间紧张的情况下写，第四单元的工作量相对来说太大了，难顶</li>
<li>对于面向对象这门课，希望少一些算法考察，第三单元的CTLE现象太坑人，第四单元的图算法太多，虽然算法也是必须掌握的内容，但是在本来任务量就大的情况下，我认为重心应该只放在架构设计上</li>
<li>第三单元可以压缩，三次作业难度都明显低于其他单元。</li>
<li>第四单元的重复工作希望可以有所减少，代码量感觉有点大。</li>
<li>希望每个单元的三次作业的描述能标记增量部分，每次拿到大几千字的文档，好多内容都和之前一模一样，也容易看不进去</li>
<li>研讨课加分政策感觉有点卷了，对于我这种又比较弱又社恐的人有种被push的感觉</li>
</ol>
<p>（超过3个了，不好意思）</p>
<p><strong>以上仅是作为一个比较弱的人的个人主观想法，可能存在发牢骚现象，如有不合理内容请无视，相信课程组多年来积累的经验，祝OO课程组越来越好！</strong></p>
<p><strong>完结撒花！！！</strong></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-05-29T03:54:00.000Z" title="2021/5/29 上午11:54:00">2021-05-29</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.646Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">11 minutes read (About 1591 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/4801/">BUAAOO-第三单元总结</a></h1><div class="content"><h1 id="BUAAOO-第三单元总结"><a href="#BUAAOO-第三单元总结" class="headerlink" title="BUAAOO-第三单元总结"></a>BUAAOO-第三单元总结</h1><h3 id="实现规格所采取的设计策略"><a href="#实现规格所采取的设计策略" class="headerlink" title="实现规格所采取的设计策略"></a>实现规格所采取的设计策略</h3><p>在第一次作业中，开始没有经验，采取了直接对规格进行“翻译”的策略，对数据保存直接使用了定长数组，后发现这样操作代码可读性不高且性能较差，于使重新改写为使用HashMap保存。</p>
<p>第二次作业中，虽然使用容器实现了数据存储，但是算法方面由于直接按照规格描述进行实现，导致了大量的CTLE。于使此后，阅读完规格后我能对方法有彻底理解后再根据自己的理解去实现。</p>
<p>再有以上经验后，认为实现规格应采取如下步骤：</p>
<ol>
<li>完整阅读规格</li>
<li>选择正确的数据结构，容器</li>
<li>正确处理异常</li>
<li>选择合适的算法实现方法</li>
</ol>
<h3 id="基于JML规格来设计测试的方法和策略"><a href="#基于JML规格来设计测试的方法和策略" class="headerlink" title="基于JML规格来设计测试的方法和策略"></a>基于JML规格来设计测试的方法和策略</h3><ol>
<li>再次阅读JML规格，检查在方法被实现前，异常是否被正确，处理检查方法是否满足规格的ensure</li>
<li>使用Junit，针对每一个具一定不确定因素的方法编写测试样例进行测试</li>
<li>对程序整体进行大数据集测试</li>
</ol>
<p>本单元看似简单，但在测试方面我做的并不理想，在三次作业中均出现了<strong>非常低级</strong>的BUG</p>
<p>第一次：</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%B8%89%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210529112328093.png"></p>
<p>原因是在阅读JML时并未彻底理解其含义，直接按照规格进行书写，导致进行了逻辑完全错误的一个判断</p>
<p>第二次：</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%B8%89%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210529112535556.png"></p>
<p>低估了自己犯低级错误的的概率（当然本次作业主要问题在CTLE上）</p>
<p>第三次：</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%B8%89%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210529112659701.png"></p>
<p>自作聪明在判断异常之前就删除了message，造成了大量WA</p>
<p>三次作业出现的bug基本都是在阅读JML规格时<strong>丧失理性</strong>造成的，事实证明在阅读JML时候一定要保证独立思考的能力，当然锅也不能全部甩到这里，<strong>归根结底还是自己懒得测试且高估了自己写简单代码不出错的能力</strong>。</p>
<p>(Junit暴力测试？)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@org</span>.junit.jupiter.api.<span class="function">Test</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">sendIndirectMessage</span><span class="params">()</span> <span class="keyword">throws</span> EqualPersonIdException, PersonIdNotFoundException, EqualRelationException, MessageIdNotFoundException, EmojiIdNotFoundException, EqualMessageIdException, RelationNotFoundException, EqualEmojiIdException </span>&#123;</span><br><span class="line">    Network network = <span class="keyword">new</span> MyNetwork();</span><br><span class="line">    network.addPerson(<span class="keyword">new</span> MyPerson(<span class="number">1</span>, <span class="string">&quot;A&quot;</span>, <span class="number">10</span>));</span><br><span class="line">    network.addPerson(<span class="keyword">new</span> MyPerson(<span class="number">3</span>, <span class="string">&quot;N&quot;</span>, <span class="number">10</span>));</span><br><span class="line">    network.addPerson(<span class="keyword">new</span> MyPerson(<span class="number">6</span>, <span class="string">&quot;F&quot;</span>, <span class="number">10</span>));</span><br><span class="line">    network.addRelation(<span class="number">1</span>, <span class="number">3</span>, <span class="number">10</span>);</span><br><span class="line">    network.addRelation(<span class="number">3</span>, <span class="number">6</span>, <span class="number">15</span>);</span><br><span class="line">    network.addRelation(<span class="number">1</span>, <span class="number">6</span>, <span class="number">26</span>);</span><br><span class="line">    network.storeEmojiId(<span class="number">1</span>);</span><br><span class="line">    network.storeEmojiId(<span class="number">3</span>);</span><br><span class="line">    network.storeEmojiId(<span class="number">5</span>);</span><br><span class="line">    network.storeEmojiId(<span class="number">7</span>);</span><br><span class="line">    network.storeEmojiId(<span class="number">9</span>);</span><br><span class="line">    network.storeEmojiId(<span class="number">91</span>);</span><br><span class="line">    network.addMessage(<span class="keyword">new</span> MyMessage(<span class="number">1</span>, <span class="number">10</span>, network.getPerson(<span class="number">1</span>), network.getPerson(<span class="number">6</span>)));</span><br><span class="line">    network.addMessage(<span class="keyword">new</span> MyEmojiMessage(<span class="number">2</span>, <span class="number">1</span>, network.getPerson(<span class="number">1</span>), network.getPerson(<span class="number">6</span>)));</span><br><span class="line">    network.addMessage(<span class="keyword">new</span> MyEmojiMessage(<span class="number">3</span>, <span class="number">1</span>, network.getPerson(<span class="number">1</span>), network.getPerson(<span class="number">6</span>)));</span><br><span class="line">    network.addMessage(<span class="keyword">new</span> MyEmojiMessage(<span class="number">4</span>, <span class="number">1</span>, network.getPerson(<span class="number">1</span>), network.getPerson(<span class="number">6</span>)));</span><br><span class="line">    network.addMessage(<span class="keyword">new</span> MyEmojiMessage(<span class="number">5</span>, <span class="number">3</span>, network.getPerson(<span class="number">1</span>), network.getPerson(<span class="number">6</span>)));</span><br><span class="line">    network.addMessage(<span class="keyword">new</span> MyEmojiMessage(<span class="number">6</span>, <span class="number">9</span>, network.getPerson(<span class="number">1</span>), network.getPerson(<span class="number">6</span>)));</span><br><span class="line">    network.addMessage(<span class="keyword">new</span> MyEmojiMessage(<span class="number">7</span>, <span class="number">91</span>, network.getPerson(<span class="number">1</span>), network.getPerson(<span class="number">6</span>)));</span><br><span class="line">    network.addMessage(<span class="keyword">new</span> MyEmojiMessage(<span class="number">8</span>, <span class="number">91</span>, network.getPerson(<span class="number">1</span>), network.getPerson(<span class="number">6</span>)));</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">8</span>; i++) &#123;</span><br><span class="line">        network.sendMessage(i + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    assertEquals(<span class="number">4</span>, network.deleteColdEmoji(<span class="number">1</span>));</span><br><span class="line">    assertEquals(<span class="keyword">true</span>,network.containsEmojiId(<span class="number">91</span>));</span><br><span class="line">    network.deleteColdEmoji(<span class="number">3</span>);</span><br><span class="line">    assertEquals(<span class="keyword">false</span>,network.containsEmojiId(<span class="number">91</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="容器选择和使用的经验"><a href="#容器选择和使用的经验" class="headerlink" title="容器选择和使用的经验"></a>容器选择和使用的经验</h3><ol>
<li>避免直接使用定长数组。</li>
<li>根据需求进行容器的选择，如果对象是通过ID来进行大部分操作，那么使用HashMap进行存储，如果对象如Person.messages，需要从头取出，从尾放入等操作，则使用ArrayList进行存储。适当的情景下也可使用Hashset来做集合的不重复性。</li>
<li>不确定要用什么的情况下，似乎还是用HashMap比较靠谱</li>
</ol>
<h3 id="性能问题"><a href="#性能问题" class="headerlink" title="性能问题"></a>性能问题</h3><p>本次作业会出现的性能问题主要集中在容器的选择，qbs的算法，ageMean，ageVar等的算法。</p>
<p>对于容器的问题，我的避免超时的方法是采取了适合的容器如HashMap</p>
<p>我在第二次作业中大面积出现了性能问题（估计能踩的坑我都踩了）</p>
<ol>
<li>qbs的算法采用了规格描述的算法直接进计算，于使我对其进行了并查集算法的修改，在addPerson和delPerson的时候就对拥有同一个根节点的节点构成一个集合。（一开始还写了DFS，慢的要死就算了，还写了一堆BUG，忙一下午，服了。）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;Integer, Integer&gt; parent = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">final</span> HashMap&lt;Integer, Integer&gt; rank = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">find</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (parent.get(id) != id) &#123;</span><br><span class="line">           parent.put(id, find(parent.get(id)));</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> parent.get(id);</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">union</span><span class="params">(<span class="keyword">int</span> id1, <span class="keyword">int</span> id2)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">int</span> p = find(id1);</span><br><span class="line">       <span class="keyword">int</span> q = find(id2);</span><br><span class="line">       <span class="keyword">if</span> (p == q) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (rank.get(p) &lt; rank.get(q)) &#123;</span><br><span class="line">           parent.put(p, q);</span><br><span class="line">       &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rank.get(p) &gt; rank.get(q)) &#123;</span><br><span class="line">           parent.put(q, p);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           parent.put(p, q);</span><br><span class="line">           rank.put(q, rank.get(q) + <span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



<ol start="2">
<li>ageMean，ageVar等的计算，起初我的计算直接采用了每次调用方法是从头开始计算的实现，结果导致每次计算要消耗大量的CPU超时，导致了CTLE，后改为在进行addperson的时候直接进行累加加和的操作，在询问ageMean的时候可以直接进行返回。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> ageSum = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> ageMean = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> ageVar = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> valueSum = <span class="number">0</span>;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addPerson</span><span class="params">(Person person)</span> </span>&#123;</span><br><span class="line">    people.put(person.getId(), person);</span><br><span class="line">    ageSum += person.getAge();</span><br><span class="line">    ageMean = ageSum / people.size();</span><br><span class="line">    ageVar = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Person p : people.values()) &#123;</span><br><span class="line">        ageVar += (p.getAge() - ageMean) * (p.getAge() - ageMean);</span><br><span class="line">        <span class="keyword">if</span> (p.isLinked(person)) &#123;</span><br><span class="line">            valueSum += p.queryValue(person) * <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ageVar = ageVar / people.size();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">delPerson</span><span class="params">(Person person)</span> </span>&#123;</span><br><span class="line">    people.remove(person.getId());</span><br><span class="line">    <span class="keyword">if</span> (people.isEmpty()) &#123;</span><br><span class="line">        initialData();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ageSum -= person.getAge();</span><br><span class="line">    ageMean = ageSum / people.size();</span><br><span class="line">    ageVar = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Person p : people.values()) &#123;</span><br><span class="line">        ageVar += (p.getAge() - ageMean) * (p.getAge() - ageMean);</span><br><span class="line">        <span class="keyword">if</span> (p.isLinked(person)) &#123;</span><br><span class="line">            valueSum -= p.queryValue(person) * <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ageVar = ageVar / people.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h3><p>除了各个对象的HashMap以外，network维护一个并查集，group维护多个基本数据，在addPerson的能操作时进行各个数据的更新。</p>
<p>不知道写什么了，这单元挺搞心态的，对自己写BUG的能力又有了新的认识，因为自己时间不够能力不足，总做不好测试这一块，我也不知道怎么办，就尽力别写bug吧。不讲丧气话，这单元学到了JML规格相关知识，好像还是挺“严谨”的，如果以后工作或者什么遇到了，应该挺受益的，不过有一说一，我是不会愿意去自己写这个JML的，如果有中文版的JML能几句话讲清楚，那没准可以试试。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-04-30T03:00:00.000Z" title="2021/4/30 上午11:00:00">2021-04-30</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.652Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">8 minutes read (About 1232 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/44178/">C++基础</a></h1><div class="content"><p><img src="http://pic.mcatk.com/soto-pictures/2021-12/%E7%9F%A5%E8%AF%86%E7%82%B9%E7%BA%B2%E8%A6%81.png" alt="知识点纲要"></p>
<p>结构</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Student</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">int</span> i;</span><br><span class="line"><span class="keyword">int</span> j;</span><br><span class="line"><span class="keyword">char</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于int需要占用4个字节，由于结构的空间分配是大对齐，总共需要12个空间。 当然也可以压缩空间，把它压缩为实际只使用的9个字节。</p>
<p>压缩：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(1)</span></span><br></pre></td></tr></table></figure>

<h3 id="宏"><a href="#宏" class="headerlink" title="宏"></a>宏</h3><p>函数宏</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ARRAY_SIZE(a) sizeof(a)/sizeof(a[0])</span></span><br></pre></td></tr></table></figure>

<p>控制宏</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> HOME <span class="comment">//用于控制开关</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> HOME</span></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;link a&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="meta">#elseif</span></span><br><span class="line">cout &lt;&lt; <span class="string">&quot;link b&quot;</span> &lt;&lt; endl;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> WIN32 <span class="comment">//windows平台上一定会有的宏</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<p>如果把C++程序和C程序混合编译</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">void</span> <span class="title">fun_C</span><span class="params">()</span></span>;</span><br></pre></td></tr></table></figure>

<p>这个语句就是用于告诉链接器，这个函数是用C标准编译的，不要按照C++编译器修饰的方式去找。</p>
<p>函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.overloading</span></span><br><span class="line"><span class="comment">//2.default parameter</span></span><br><span class="line"><span class="comment">//默认参数必须放后</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun2</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b = <span class="number">3</span>, <span class="keyword">int</span> c = <span class="number">4</span>)</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; a &lt;&lt; b &lt;&lt; c &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3.占位参数</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun3</span><span class="params">(<span class="keyword">int</span>)</span> </span>&#123;</span><br><span class="line">    cout &lt;&lt; <span class="number">233</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="C-面向对象"><a href="#C-面向对象" class="headerlink" title="C++ 面向对象"></a>C++ 面向对象</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Person</span> &#123;</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">char</span> *name;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Person</span>(<span class="keyword">int</span> aage, <span class="keyword">char</span> *aname);</span><br><span class="line">    ~<span class="built_in">Person</span>();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Person::<span class="built_in">Person</span>(<span class="keyword">int</span> aage, <span class="keyword">char</span> *aname) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;age = aage;</span><br><span class="line">    <span class="keyword">this</span>-&gt;name = aname;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Person::~<span class="built_in">Person</span>()&#123;</span><br><span class="line">    <span class="comment">//析构函数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>struct和class区别：class默认成员变量private</p>
<p>默认构造：不带括号</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Test <span class="title">t1</span><span class="params">(<span class="number">3</span>)</span></span>;</span><br><span class="line">Test *t2 = <span class="keyword">new</span> <span class="built_in">Test</span>();</span><br><span class="line"><span class="function">Test <span class="title">t3</span><span class="params">(<span class="number">2</span>,<span class="number">3</span>)</span></span>;</span><br><span class="line"><span class="function">Test <span class="title">t4</span><span class="params">()</span></span>; <span class="comment">//this is a function</span></span><br><span class="line">Test t4;</span><br><span class="line">Test *t5 = <span class="keyword">new</span> <span class="built_in">Test</span>(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>

<p>函数的原则：尽量不用返回值去返回，输入输出参数放在参数里</p>
<p>成员变量原则：</p>
<p>value：必然组成部分</p>
<p>address：可有可无的部分</p>
<p>类嵌套：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Circle</span>&#123;</span></span><br><span class="line">    Point *p;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Point</span>&#123;</span></span><br><span class="line">    Circle c;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>析构函数(destructor)：</p>
<p>对象消亡时自动调用</p>
<p>可用于free堆区malloc</p>
<p>防止重复free，free时：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (p != <span class="literal">NULL</span>) &#123;</span><br><span class="line">        <span class="built_in">free</span>(p);</span><br><span class="line">        p = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="指针与引用"><a href="#指针与引用" class="headerlink" title="指针与引用"></a>指针与引用</h3><p>指针的问题</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1. fly pointer (if null / assert)</span></span><br><span class="line"><span class="comment">//2. memory leak (free)</span></span><br><span class="line"><span class="comment">//3. return addr of local var</span></span><br><span class="line"><span class="comment">//4. multi-pointers for one object</span></span><br></pre></td></tr></table></figure>

<p>引用</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//reference 引用</span></span><br><span class="line"><span class="keyword">int</span> m = <span class="number">5</span>;</span><br><span class="line"><span class="keyword">int</span> &amp;r = m; <span class="comment">//m的小名</span></span><br></pre></td></tr></table></figure>

<p>对象的copy</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//bitwise copy 浅拷贝（默认） vs. logical copy 深拷贝</span></span><br><span class="line"><span class="comment">//copy constructor</span></span><br><span class="line">Test::<span class="built_in">Test</span>(Test &amp;t) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;i = t.i;</span><br><span class="line">    <span class="comment">//!!!this-&gt; = t.j</span></span><br><span class="line">    <span class="keyword">this</span>-&gt;j = (<span class="keyword">int</span> *) <span class="built_in">malloc</span>(<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>));</span><br><span class="line">    *j = *t.j;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>e</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//    pass by value vs. pass by address(pointer or reference)</span></span><br><span class="line"><span class="comment">//效果 read              read/write</span></span><br><span class="line"><span class="comment">//性能 sizeof(object)    sizeof(int)</span></span><br><span class="line"><span class="comment">//麻烦 copy-constructor  nothing</span></span><br><span class="line"><span class="comment">//conclusion: never pass by value(build-in type except)</span></span><br></pre></td></tr></table></figure>

<h3 id="new-and-delete"><a href="#new-and-delete" class="headerlink" title="new and delete"></a>new and delete</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Test *p = (Test *)malloc(sizeof (Test));</span></span><br><span class="line">Test *p =<span class="keyword">new</span> <span class="built_in">Test</span>(<span class="number">1</span>,<span class="number">2</span>);</span><br><span class="line"><span class="comment">//new = malloc + constructor</span></span><br><span class="line"><span class="keyword">delete</span> p;</span><br><span class="line"><span class="comment">//delete = destructor + free;</span></span><br><span class="line"><span class="comment">//多个对象</span></span><br><span class="line">Test *p = <span class="keyword">new</span> Test[<span class="number">10</span>]; <span class="comment">//要求有默认构造</span></span><br><span class="line"><span class="keyword">delete</span> []p;</span><br></pre></td></tr></table></figure>

<h3 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Test::fun</span><span class="params">()</span> <span class="keyword">const</span></span>&#123;</span><br><span class="line">    <span class="comment">//read only function</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> Test t;</span><br><span class="line">t.<span class="built_in">fun</span>();</span><br></pre></td></tr></table></figure>

<h3 id="static"><a href="#static" class="headerlink" title="static"></a>static</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">fun</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">static</span> <span class="keyword">int</span> i; <span class="comment">//堆区，与全局变量同</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="extern"><a href="#extern" class="headerlink" title="extern"></a>extern</h6><p>全局变量不定义在头文件，定义在某一源文件中</p>
<p>extern外链接放在头文件。</p>
<p>函数默认extern外链接，用static修饰表明作用域为本文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extern int g_i;</span><br></pre></td></tr></table></figure>

<p>类中static修饰：全类的共享空间</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span>&#123;</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">int</span> j;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Test</span>(<span class="keyword">int</span> aj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//显示一次性初始化</span></span><br><span class="line"><span class="keyword">int</span> Test::i = <span class="number">100</span>;</span><br></pre></td></tr></table></figure>

<p>static无this指针</p>
<h3 id="operator"><a href="#operator" class="headerlink" title="operator"></a>operator</h3><p> 重载运算符</p>
<p><code>[]</code> 重载数组 <code>*</code> 重载取内容 <code>new delet</code> 重载malloc <code>++</code>重载++</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Account</span>&#123;</span></span><br><span class="line">    <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">int</span> balance;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    Account &amp;<span class="keyword">operator</span>+(<span class="keyword">int</span> n);</span><br><span class="line">    <span class="comment">//++a</span></span><br><span class="line">    Account&amp; <span class="keyword">operator</span>++();</span><br><span class="line">    <span class="comment">//a++</span></span><br><span class="line">    Account <span class="keyword">operator</span>++(<span class="keyword">int</span>);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Account &amp;Account::<span class="keyword">operator</span>+(<span class="keyword">int</span> n) &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;balance += n;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Account&amp; Account::<span class="keyword">operator</span>++() &#123;</span><br><span class="line">    <span class="keyword">this</span>-&gt;balance++;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Account Account::<span class="keyword">operator</span>++(<span class="keyword">int</span>) &#123;</span><br><span class="line">    Account old = *<span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">this</span>-&gt;balance++;</span><br><span class="line">    <span class="keyword">return</span> old;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Account a;</span><br><span class="line">    a = a+<span class="number">100</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="继承-inheritance-与组成-composition"><a href="#继承-inheritance-与组成-composition" class="headerlink" title="继承(inheritance)与组成(composition)"></a>继承(inheritance)与组成(composition)</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//(derived class)子类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span> :</span> <span class="keyword">public</span> Borrower</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">borrow_book</span><span class="params">()</span></span>;    </span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Student::borrow_book</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    Borrower::<span class="built_in">borrow_book</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;if&gt;=5 return&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>注意构造顺序</p>
<p>子类构造器自动调用父类构造器，析构相反</p>
<p>组成也会先自动调用内部对象的构造(Engine initial - Car initial)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//构造器初始化列表(若没有默认构造无法默认调用)</span></span><br><span class="line">Derived::<span class="built_in">Derived</span>(<span class="keyword">int</span> ai, <span class="keyword">int</span> aj):<span class="built_in">Base</span>(ai)&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//有先后顺序</span></span><br><span class="line">Test::<span class="built_in">Test</span>(<span class="keyword">int</span> ai, <span class="keyword">int</span> aj) :<span class="built_in">i</span>(ai),<span class="built_in">j</span>(aj)&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多继承(菱形结构)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Derived</span> :</span> <span class="keyword">public</span> Base1, <span class="keyword">public</span> Base2&#123;&#125;</span><br></pre></td></tr></table></figure>

<h3 id="多态"><a href="#多态" class="headerlink" title="多态"></a>多态</h3><ol>
<li>upcasting 向上转换</li>
<li>later binding vs. early binding </li>
<li>polymorphism 多态性</li>
<li>virtual </li>
<li>constructor &amp; destructor 构造无多态，析构往往多态</li>
<li>abstract class (interface in Java &amp; C#)</li>
</ol>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pet</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">char</span> *name;</span><br><span class="line">    <span class="keyword">int</span> age;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">speak</span><span class="params">()</span></span>; <span class="comment">//虚函数 内存占用+8 子类自动virtual</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">Needle</span><span class="params">(Pet&amp; pet)</span> <span class="comment">//never pass by value 拷贝构造使多态失效</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//binding</span></span><br><span class="line">    <span class="comment">//1. early binding</span></span><br><span class="line">    <span class="comment">//2. later(dynamic/runtime) binding</span></span><br><span class="line">    pet.<span class="built_in">speak</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>多态的实现：</p>
<p>类：V-table 虚函数表</p>
<p>对象：V-ptr 指向本类虚函数</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//纯虚函数</span></span><br><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">void</span> <span class="title">speak</span><span class="params">()</span> </span>= <span class="number">0</span>;</span><br><span class="line"><span class="comment">//抽象类：含纯虚函数，无法创建对象</span></span><br></pre></td></tr></table></figure>

<p>行为串联：当两个类别家族因为行为共性发生关系时，用抽象类来关联两个类别家族</p>
<h5 id="template-class"><a href="#template-class" class="headerlink" title="template class"></a>template class</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//template class 模板类 collection in Java</span></span><br><span class="line"><span class="keyword">template</span>&lt;<span class="class"><span class="keyword">class</span> <span class="title">T</span>&gt;</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Stack</span> &#123;</span></span><br><span class="line">    T pool[<span class="number">100</span>];</span><br><span class="line">    <span class="keyword">int</span> top;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="comment">//内联函数 inline function</span></span><br><span class="line">    <span class="comment">//top=0</span></span><br><span class="line">    <span class="built_in">Stack</span>() : <span class="built_in">top</span>(<span class="number">0</span>) &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">push</span><span class="params">(T v)</span> </span>&#123;</span><br><span class="line">        pool[top++] = v;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">pop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> pool[--top];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Stack&lt;<span class="keyword">int</span>&gt; s1;</span><br><span class="line">    Stack&lt;<span class="keyword">double</span>&gt; s2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>STL</code></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//STL: standard template library</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vector&lt;<span class="keyword">int</span>&gt; v;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10000</span>; ++i) </span><br><span class="line">    &#123;</span><br><span class="line">        v.<span class="built_in">push_back</span>(i);</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; v[<span class="number">9988</span>] &lt;&lt; endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>iterator</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vector&lt;<span class="keyword">int</span>&gt; v;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; ++i) &#123;</span><br><span class="line">    v.<span class="built_in">push_back</span>(i);</span><br><span class="line">&#125;</span><br><span class="line">vector&lt;<span class="keyword">int</span>&gt;::iterator it = v.<span class="built_in">begin</span>();</span><br><span class="line"><span class="keyword">while</span> (it != v.<span class="built_in">end</span>()) &#123;</span><br><span class="line">    cout &lt;&lt; *it &lt;&lt; endl;</span><br><span class="line">    it++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>name space类上一级层次 </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> my_nsp</span><br></pre></td></tr></table></figure>

<p>try catch 和Java一样</p>
<p>assert</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//让断言全部失效</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NDEBUG</span></span><br></pre></td></tr></table></figure>

<p>friend</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item">Posted&nbsp;<time dateTime="2021-04-25T14:33:00.000Z" title="2021/4/25 下午10:33:00">2021-04-25</time></span><span class="level-item">Updated&nbsp;<time dateTime="2021-12-05T16:45:29.649Z" title="2021/12/6 上午12:45:29">2021-12-06</time></span><span class="level-item">7 minutes read (About 1018 words)</span></div></div><h1 class="title is-3 is-size-4-mobile"><a class="link-muted" href="/posts/54734/">BUAAOO-第二单元总结</a></h1><div class="content"><h1 id="BUAAOO-第二单元总结"><a href="#BUAAOO-第二单元总结" class="headerlink" title="BUAAOO-第二单元总结"></a>BUAAOO-第二单元总结</h1><h2 id="作业分析"><a href="#作业分析" class="headerlink" title="作业分析"></a>作业分析</h2><h3 id="同步块与锁"><a href="#同步块与锁" class="headerlink" title="同步块与锁"></a>同步块与锁</h3><p>InputThread捕捉输入，将其加入waitQueue队列中</p>
<p>Dispatcher负责控制waitQueue，对waitQueue的操作需要经过Dispatcher</p>
<p>Elevator为电梯个体对象，其内包含一个requests用于表示目前位于电梯里的请求</p>
<p>其中，锁全部位于调度器中</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> PersonRequest <span class="title">checkTopRequest</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (waitQueue) &#123;</span><br><span class="line">        <span class="keyword">int</span> max = <span class="number">0</span>;</span><br><span class="line">        PersonRequest request = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (PersonRequest r : waitQueue) &#123;</span><br><span class="line">            <span class="keyword">if</span> (r.getFromFloor() &gt; max) &#123;</span><br><span class="line">                max = r.getFromFloor();</span><br><span class="line">                request = r;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> request;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>三次作业都为相同的设计，Dispatcher基本没有变动。</p>
<h3 id="调度器设计与线程交互"><a href="#调度器设计与线程交互" class="headerlink" title="调度器设计与线程交互"></a>调度器设计与线程交互</h3><p>外部可以放心与调度器进行交互，类似生产者消费者模型，调度器维护waitQueue，输入线程通过调度器向其中加入请求，电梯通过调度器查询和获取请求</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%BA%8C%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210425163631337.png"></p>
<p>第二、三次作业中加入了多个电梯与dispatcher交互</p>
<p>电梯策略：</p>
<p>Random：自由竞争，直接去找队列中第一个目标，接到请求后，优先处理电梯中的第一个请求，在运行过程中在每层判断是否可以接送乘客并且进行操作。</p>
<p>Morning：电梯位于1层，开始接人，2s后出发，一直送到电梯内请求列表的最高层后返回，依次循环</p>
<p>Night：直接前往队列中最高层接人，向下过程中继续接人，回到一层后依次循环。</p>
<h3 id="UML"><a href="#UML" class="headerlink" title="UML"></a>UML</h3><h5 id="第一次作业"><a href="#第一次作业" class="headerlink" title="第一次作业"></a>第一次作业</h5><p>Main创建输入和电梯线程以及调度器，输入线程提供mode，requests，end等，调度器负责控制队列，elevator进行运行。</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%BA%8C%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210425171756534.png"></p>
<p>流程图：</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%BA%8C%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210425214505979.png"></p>
<h5 id="第二次作业"><a href="#第二次作业" class="headerlink" title="第二次作业"></a>第二次作业</h5><p>相比第一次作业，输入线程负责创建新的Elevator</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%BA%8C%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210425215005256.png"></p>
<p>流程图</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%BA%8C%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210425215341767.png"></p>
<h5 id="第三次作业"><a href="#第三次作业" class="headerlink" title="第三次作业"></a>第三次作业</h5><p>结构和第二次没有什么不同，在电梯类内部进行了ABC的区分，没有进行换乘的优化，仅仅是规定了各个电梯可人的层数后进行自由竞争。</p>
<p>流程图</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%BA%8C%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210425220331346.png"></p>
<h3 id="分析自己程序的bug"><a href="#分析自己程序的bug" class="headerlink" title="分析自己程序的bug"></a>分析自己程序的bug</h3><p>在第一次作业没有互测bug。</p>
<p>第二次作业自测的bug主要集中在没有正确结束线程。互测没有被找到bug，但是强测出现了一个超载的bug，原因在进行电梯可承载人数时加减号使用错误导致超载。</p>
<p>第三次作业自测阶段的bug主要在电梯由于型号不同，理论上结束标志不一，我在while循环结束的时候仅判断了input的信号，导致部分电梯提前结束，后来又因为没有正确结束导致while死循环CPU超时。</p>
<p>在互测中被hack一次，原因是我没有进行换乘优化，对方的数据点为集中的密集底层到高层数据，我的电梯只有C会去接人，导致超时。</p>
<h3 id="分析自己发现别人程序bug所采用的策略"><a href="#分析自己发现别人程序bug所采用的策略" class="headerlink" title="分析自己发现别人程序bug所采用的策略"></a>分析自己发现别人程序bug所采用的策略</h3><p>能力有限，这几次没有对他人的程序进行bug测试</p>
<h3 id="心得体会"><a href="#心得体会" class="headerlink" title="心得体会"></a>心得体会</h3><p>多线程的加入使得程序有了更多的不确定性，增加了测试的难度，但总而言之，只要做好线程的安全，如定义好线程安全类在进行操作，处理好线程的结束，不产生轮询，就可以避免多线程带来的bug。线程之间的交互在逻辑上就如同P6流水线的竞争一样，需要进行大量情况的考虑。在这几次作业中，我学会了多线程程序的正确处理。</p>
<p>最终代码量</p>
<p><img src="BUAAOO-%E7%AC%AC%E4%BA%8C%E5%8D%95%E5%85%83%E6%80%BB%E7%BB%93/image-20210425225410022.png"></p>
</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous"><a href="/page/2/">Previous</a></div><div class="pagination-next"><a href="/page/4/">Next</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link" href="/">1</a></li><li><a class="pagination-link" href="/page/2/">2</a></li><li><a class="pagination-link is-current" href="/page/3/">3</a></li><li><a class="pagination-link" href="/page/4/">4</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-4-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar is-rounded" src="http://pic.mcatk.com/soto-pictures/2021-12/PEqcQi.jpeg" alt="soto"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">soto</p><p class="is-size-6 is-block">多喝水</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Beijing</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">Posts</p><a href="/archives"><p class="title">33</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Categories</p><a href="/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">Tags</p><a href="/tags"><p class="title">17</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/acsoto" target="_blank" rel="noopener">Follow</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/acsoto"><i class="fab fa-github"></i></a></div></div></div><!--!--><!--!--><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">Tags</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/tags/AtTackCraft/"><span class="tag">AtTackCraft</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/BUAA/"><span class="tag">BUAA</span><span class="tag">9</span></a></div><div class="control"><a class="tags has-addons" href="/tags/C/"><span class="tag">C++</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MacOS/"><span class="tag">MacOS</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/MySQL/"><span class="tag">MySQL</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Shell/"><span class="tag">Shell</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/Swift/"><span class="tag">Swift</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/hexo/"><span class="tag">hexo</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%8F%A4%E5%85%B8%E9%9F%B3%E4%B9%90/"><span class="tag">古典音乐</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%90%90%E6%A7%BD/"><span class="tag">吐槽</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E5%BC%80%E5%8F%91/"><span class="tag">开发</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E6%8E%A8%E6%AD%8C/"><span class="tag">推歌</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%94%B5%E5%BD%B1/"><span class="tag">电影</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E7%BC%96%E8%AF%91/"><span class="tag">编译</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9A%8F%E6%83%B3/"><span class="tag">随想</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1/"><span class="tag">面向对象</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/tags/%E9%A1%B9%E7%9B%AE/"><span class="tag">项目</span><span class="tag">3</span></a></div></div></div></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">Archives</h3><ul class="menu-list"><li><a class="level is-mobile" href="/archives/2021/12/"><span class="level-start"><span class="level-item">December 2021</span></span><span class="level-end"><span class="level-item tag">7</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/11/"><span class="level-start"><span class="level-item">November 2021</span></span><span class="level-end"><span class="level-item tag">18</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/10/"><span class="level-start"><span class="level-item">October 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/06/"><span class="level-start"><span class="level-item">June 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/05/"><span class="level-start"><span class="level-item">May 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/04/"><span class="level-start"><span class="level-item">April 2021</span></span><span class="level-end"><span class="level-item tag">2</span></span></a></li><li><a class="level is-mobile" href="/archives/2021/03/"><span class="level-start"><span class="level-item">March 2021</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/12/"><span class="level-start"><span class="level-item">December 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li><li><a class="level is-mobile" href="/archives/2020/10/"><span class="level-start"><span class="level-item">October 2020</span></span><span class="level-end"><span class="level-item tag">1</span></span></a></li></ul></div></div></div></div><!--!--></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/">SOTO-BLOG</a><p class="is-size-7"><span>&copy; 2021 soto</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/"><i class="fab fa-creative-commons-by"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("en");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/js/column.js"></script><script src="/js/animation.js"></script><a id="back-to-top" title="Back to top" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "This website uses cookies to improve your experience.",
          dismiss: "Got it!",
          allow: "Allow cookies",
          deny: "Decline",
          link: "Learn more",
          policy: "Cookie Policy",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><script type="text/x-mathjax-config">MathJax.Hub.Config({
            'HTML-CSS': {
                matchFontHeight: false
            },
            SVG: {
                matchFontHeight: false
            },
            CommonHTML: {
                matchFontHeight: false
            },
            tex2jax: {
                inlineMath: [
                    ['$','$'],
                    ['\\(','\\)']
                ]
            }
        });</script><script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script><!--!--><!--!--><!--!--><script src="/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="Type something..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/content.json"}, {"hint":"Type something...","untitled":"(Untitled)","posts":"Posts","pages":"Pages","categories":"Categories","tags":"Tags"});
        });</script></body></html>